<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تنظیمات پروفایل - آیدا شیرازی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0A192F; --slate-800: #1e293b; --slate-600: #475569;
            --slate-100: #f1f5f9; --gold: #c49827; --light-gold: #FBEFCE;
            --font-display: 'Lalezar', cursive; --font-body: 'Vazirmatn', sans-serif;
        }
        body { font-family: var(--font-body); background-color: var(--slate-100); }
        h1, h2, .font-display { font-family: var(--font-display); }
        .btn-gold { 
            background-color: var(--gold); color: var(--navy);
            transition: background-color 0.3s;
        }
        .btn-gold:hover { background-color: #b98d1e; }
    </style>
</head>
<body class="bg-slate-100">

    <header class="bg-white shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-xl font-bold font-display" style="color: var(--navy);">آیدا شیرازی</a>
            <a href="index.html" class="text-sm font-medium text-[var(--gold)] hover:underline">بازگشت به صفحه اصلی</a>
        </nav>
    </header>

    <main class="container mx-auto p-6 mt-8">
        <h1 class="text-4xl font-display text-center text-[var(--navy)] mb-10">تنظیمات حساب کاربری</h1>

        <div class="max-w-lg mx-auto space-y-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-display text-slate-800 border-b pb-3 mb-4">تغییر نام کاربری</h2>
                <form id="username-form" class="space-y-4">
                    <div>
                        <label for="username" class="text-sm font-medium text-slate-700">نام کاربری جدید</label>
                        <input id="username" type="text" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-[var(--gold)] focus:border-[var(--gold)]">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-md font-semibold btn-gold">ذخیره نام کاربری</button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-display text-slate-800 border-b pb-3 mb-4">تغییر رمز عبور</h2>
                <form id="password-form" class="space-y-4">
                    <div>
                        <label for="current-password" class="text-sm font-medium text-slate-700">رمز عبور فعلی</label>
                        <input id="current-password" type="password" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <hr/>
                    <div>
                        <label for="new-password" class="text-sm font-medium text-slate-700">رمز عبور جدید</label>
                        <input id="new-password" type="password" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                         <p class="mt-2 text-xs text-slate-500">حداقل ۸ کاراکتر، شامل حروف بزرگ و کوچک، عدد و علائم خاص.</p>
                    </div>
                     <div>
                        <label for="confirm-password" class="text-sm font-medium text-slate-700">تکرار رمز عبور جدید</label>
                        <input id="confirm-password" type="password" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-md font-semibold btn-gold">ذخیره رمز عبور</button>
                </form>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://evfgzegtplkhocfxcjpp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2Zmd6ZWd0cGxraG9jZnhjanBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDgyOTUsImV4cCI6MjA3NDcyNDI5NX0.eUDSqjhSK7Tk8rHfXV_tFTBzGbT3jBHJnLG70WVpV44';

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { storage: window.sessionStorage } });

        const usernameForm = document.getElementById('username-form');
        const passwordForm = document.getElementById('password-form');
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
            } else {
                currentUser = user;
            }
        });

        usernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = e.target.username.value;
            if (currentUser) {
                const { error } = await _supabase.from('profiles').update({ username: newUsername }).eq('id', currentUser.id);
                if (error) {
                    if (error.code === '23505') { alert('خطا: این نام کاربری قبلاً استفاده شده است.'); } 
                    else { alert('خطا در به‌روزرسانی نام کاربری: ' + error.message); }
                } else {
                    alert('نام کاربری شما با موفقیت تغییر کرد.');
                    e.target.username.value = '';
                }
            }
        });
        
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = e.target['current-password'].value;
            const newPassword = e.target['new-password'].value;
            const confirmPassword = e.target['confirm-password'].value;

            if (newPassword !== confirmPassword) {
                alert('رمز عبور جدید و تکرار آن یکسان نیستند.');
                return;
            }

            const hasUpperCase = /[A-Z]/.test(newPassword);
            const hasLowerCase = /[a-z]/.test(newPassword);
            const hasNumber = /\d]/.test(newPassword);
            const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword);
            if (newPassword.length < 8 || !hasUpperCase || !hasLowerCase || !hasNumber || !hasSpecialChar) {
                alert('رمز عبور جدید باید حداقل ۸ کاراکتر و شامل حرف بزرگ، حرف کوچک، عدد و علائم خاص باشد.');
                return;
            }

            if (currentUser) {
                const { error: reauthError } = await _supabase.auth.signInWithPassword({ email: currentUser.email, password: currentPassword });
                if (reauthError) {
                    alert('رمز عبور فعلی شما اشتباه است.');
                    return;
                }
            } else { return; }
            
            const { error: updateError } = await _supabase.auth.updateUser({ password: newPassword });
            if (updateError) {
                alert('خطا در تغییر رمز عبور: ' + updateError.message);
            } else {
                alert('رمز عبور شما با موفقیت تغییر کرد.');
                e.target['current-password'].value = '';
                e.target['new-password'].value = '';
                e.target['confirm-password'].value = '';
            }
        });
    </script>
</body>
</html>