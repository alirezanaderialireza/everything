<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقویم هوشمند حسابداری - آیدا شیرازی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Vazirmatn:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jalali-moment@3.3.11/dist/jalali-moment.browser.js"></script>
    <style>
        :root {
            --navy: #0A192F;
            --slate-800: #1e2b3b;
            --slate-600: #475569;
            --slate-100: #f1f5f9;
            --gold: #c49827;
            --light-gold: #FBEFCE;
            --font-display: 'Lalezar', cursive;
            --font-body: 'Vazirmatn', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--slate-100);
        }

        h1,
        h2,
        h3,
        h4,
        .font-display {
            font-family: var(--font-display);
        }

        .main-header {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-link {
            transition: color 0.3s ease;
            color: var(--slate-800);
            font-weight: 500;
            position: relative;
            padding-bottom: 4px;
        }

        .nav-link:hover {
            color: var(--navy);
        }

        .btn-gold {
            background-color: var(--gold);
            color: var(--navy);
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.75rem;
            transition: all 0.2s;
        }

        .btn-gold:hover {
            background-color: #b98d1e;
            transform: translateY(-2px);
        }

        #live-clock-display {
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--navy);
        }

        #calendar-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background-color: var(--navy);
            color: white;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
        }

        .calendar-month-display {
            font-family: var(--font-display);
            font-size: 2rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .weekday-header {
            text-align: center;
            padding: 0.75rem 0;
            font-weight: 600;
            color: var(--slate-600);
            background-color: var(--slate-100);
            border-bottom: 1px solid #e2e8f0;
        }

        .day-cell {
            position: relative;
            min-height: 120px;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .day-cell:nth-child(7n) {
            border-left: none;
        }

        .day-cell:hover {
            background-color: var(--light-gold);
        }

        .day-cell.today .day-number {
            background-color: var(--gold);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .day-cell.selected {
            background-color: var(--light-gold);
            border: 2px solid var(--gold);
        }

        .event-dot {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--gold);
        }

        .day-events-list {
            font-size: 0.75rem;
            margin-top: 4px;
        }

        .event-title-inline,
        .personal-event-inline {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
        }

        .event-title-inline {
            background: var(--navy);
            color: white;
        }

        .personal-event-inline {
            background-color: var(--event-color, var(--gold));
            color: white;
        }

        #day-details-container {
            background-color: white;
            padding: 2rem;
            min-height: 100px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        #details-list li {
            background: var(--slate-100);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-right: 4px solid var(--gold);
        }

        #notification-toast.show {
            transform: translateX(0);
        }
    </style>
</head>

<body class="bg-slate-100">

    <header class="main-header sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <img src="https://i.postimg.cc/j519gM1p/dd6fd5aa-9d3e-4a23-85e5-5ee9a534197e.jpg" alt="لوگو"
                        class="w-10 h-10 rounded-full">
                    <a href="index.html" class="text-xl font-bold font-display" style="color: var(--navy);">آیدا
                        شیرازی</a>
                </div>
                <div id="live-clock-display" class="hidden md:block">--:--:--</div>
            </div>
            <div class="hidden md:flex items-center space-x-10 space-x-reverse">
                <a href="index.html#roadmap" class="nav-link">نقشه راه</a>
                <a href="documents.html" class="nav-link">اسناد حسابداری</a>
                <a href="calendar.html" class="nav-link">تقویم هوشمند</a>
                <a href="calculator.html" class="nav-link">ماشین حساب</a>
                <a href="index.html#updates" class="nav-link">آخرین تغییرات</a>
                <a href="index.html#about" class="nav-link">درباره من</a>
            </div>
            <div id="profile-section" class="relative">
                <a href="login.html" id="login-btn" class="btn-gold flex items-center justify-center gap-2 px-6 py-2">
                    <i class="fa-solid fa-right-to-bracket"></i><span>ورود / ثبت‌نام</span>
                </a>
                <div id="user-menu" style="display: none;">
                    <button id="profile-toggle-btn"
                        class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--gold)]">
                        <i class="fa-solid fa-user text-slate-600"></i>
                    </button>
                    <div id="dropdown-menu"
                        class="hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-50">
                        <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">تنظیمات
                            پروفایل</a>
                        <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">خروج
                            از حساب</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <h1 class="text-4xl md:text-5xl font-display text-center mb-12" style="color: var(--navy);">تقویم هوشمند
            حسابداری</h1>

        <div class="max-w-4xl mx-auto mb-8 text-center" id="premium-features-section">
            <div id="upgrade-calendar-prompt" style="display: none;">
                <a href="checkout-calendar.html" class="inline-block">
                    <button class="btn-gold"><i class="fa-solid fa-crown ml-2"></i><span>خرید و فعال‌سازی نسخه
                            پیشرفته</span></button>
                </a>
            </div>
            <div id="premium-buttons-container" class="space-x-4 space-x-reverse">
                <button id="add-event-btn-main" class="btn-gold"><i class="fa-solid fa-plus ml-2"></i><span>افزودن
                        رویداد</span></button>
                <a href="weekly-calendar.html" class="btn-gold bg-slate-700 text-white hover:bg-slate-800"><i
                        class="fa-solid fa-calendar-week ml-2"></i><span>نمای هفتگی</span></a>
            </div>
        </div>

        <div id="calendar-container">
            <div class="calendar-header">
                <button id="prev-month-btn" class="calendar-nav-btn"><i class="fa fa-chevron-right"></i></button>
                <div id="month-display" class="calendar-month-display">...</div>
                <button id="next-month-btn" class="calendar-nav-btn"><i class="fa fa-chevron-left"></i></button>
            </div>
            <div class="calendar-grid weekday-grid">
                <div class="weekday-header">شنبه</div>
                <div class="weekday-header">یکشنبه</div>
                <div class="weekday-header">دوشنبه</div>
                <div class="weekday-header">سه‌شنبه</div>
                <div class="weekday-header">چهارشنبه</div>
                <div class="weekday-header">پنجشنبه</div>
                <div class="weekday-header">جمعه</div>
            </div>
            <div id="calendar-days-grid" class="calendar-grid"></div>
        </div>

        <div id="day-details-container" class="mt-8">
            <h3 class="text-2xl mb-4">رویدادهای روز انتخاب شده:</h3>
            <ul id="details-list">
                <li>روزی را برای مشاهده جزئیات انتخاب کنید.</li>
            </ul>
        </div>
        <div id="event-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                <h2 id="modal-title" class="text-2xl font-display text-[var(--navy)] mb-6">ثبت رویداد جدید</h2>
                <form id="event-form" class="space-y-4">
                    <input type="hidden" id="event-id">
                    <div>
                        <label for="event-title" class="text-sm font-medium text-slate-700">عنوان رویداد</label>
                        <input id="event-title" type="text" required
                            class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-[var(--gold)] outline-none">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-700">دسته‌بندی</label>
                        <div class="category-selector mt-1">
                            <input type="radio" name="category" id="cat-meeting"
                                value='{"name": "جلسه", "color": "#0A192F"}' checked><label for="cat-meeting"
                                style="--cat-color: #0A192F;">جلسه</label>
                            <input type="radio" name="category" id="cat-deadline"
                                value='{"name": "مهلت قانونی", "color": "#ef4444"}'><label for="cat-deadline"
                                style="--cat-color: #ef4444;">مهلت قانونی</label>
                            <input type="radio" name="category" id="cat-personal"
                                value='{"name": "شخصی", "color": "#22c55e"}'><label for="cat-personal"
                                style="--cat-color: #22c55e;">شخصی</label>
                            <input type="radio" name="category" id="cat-reminder"
                                value='{"name": "یادآوری", "color": "#c49827"}'><label for="cat-reminder"
                                style="--cat-color: #c49827;">یادآوری</label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="event-date" class="text-sm font-medium text-slate-700">تاریخ شروع</label>
                            <input id="event-date" type="date" required class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div class="flex items-center pt-6">
                            <input id="is-all-day" type="checkbox"
                                class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]">
                            <label for="is-all-day" class="mr-2 text-sm font-medium text-slate-700">رویداد تمام
                                روز</label>
                        </div>
                    </div>
                    <div id="time-inputs" class="grid grid-cols-2 gap-4">
                        <div><label for="start-time" class="text-sm font-medium text-slate-700">ساعت شروع</label><input
                                id="start-time" type="time" required class="mt-1 w-full p-2 border rounded-md"></div>
                        <div><label for="end-time" class="text-sm font-medium text-slate-700">ساعت پایان</label><input
                                id="end-time" type="time" required class="mt-1 w-full p-2 border rounded-md"></div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex items-center">
                            <input id="is-recurring" type="checkbox"
                                class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]">
                            <label for="is-recurring" class="mr-2 text-sm font-bold text-slate-800">رویداد
                                تکرارشونده</label>
                        </div>
                    </div>
                    <div id="recurring-options" class="hidden space-y-4 p-4 bg-slate-50 rounded-lg border">
                        <div>
                            <label class="text-sm font-medium text-slate-700 mb-2 block">تکرار در روزهای:</label>
                            <div class="flex flex-wrap gap-x-4 gap-y-2" id="weekday-selector">
                                <div class="flex items-center"><input type="checkbox" id="day-6" value="6"
                                        class="form-checkbox h-4 w-4"><label for="day-6"
                                        class="mr-2 text-sm">شنبه</label></div>
                                <div class="flex items-center"><input type="checkbox" id="day-0" value="0"
                                        class="form-checkbox h-4 w-4"><label for="day-0"
                                        class="mr-2 text-sm">یکشنبه</label></div>
                                <div class="flex items-center"><input type="checkbox" id="day-1" value="1"
                                        class="form-checkbox h-4 w-4"><label for="day-1"
                                        class="mr-2 text-sm">دوشنبه</label></div>
                                <div class="flex items-center"><input type="checkbox" id="day-2" value="2"
                                        class="form-checkbox h-4 w-4"><label for="day-2"
                                        class="mr-2 text-sm">سه‌شنبه</label></div>
                                <div class="flex items-center"><input type="checkbox" id="day-3" value="3"
                                        class="form-checkbox h-4 w-4"><label for="day-3"
                                        class="mr-2 text-sm">چهارشنبه</label></div>
                                <div class="flex items-center"><input type="checkbox" id="day-4" value="4"
                                        class="form-checkbox h-4 w-4"><label for="day-4"
                                        class="mr-2 text-sm">پنجشنبه</label></div>
                                <div class="flex items-center"><input type="checkbox" id="day-5" value="5"
                                        class="form-checkbox h-4 w-4"><label for="day-5"
                                        class="mr-2 text-sm">جمعه</label></div>
                            </div>
                        </div>
                        <div>
                            <label for="end-date" class="text-sm font-medium text-slate-700">تاریخ پایان تکرار</label>
                            <input id="end-date" type="date" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex items-center">
                            <input id="show-on-dashboard" type="checkbox"
                                class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]"
                                checked>
                            <label for="show-on-dashboard" class="mr-2 text-sm font-medium text-slate-700">نمایش در ویجت
                                صفحه اصلی</label>
                        </div>
                    </div>
                    <div class="pt-4 flex justify-between items-center">
                        <button type="button" id="delete-event-btn"
                            class="px-4 py-2 rounded-md text-red-600 hover:bg-red-50 hidden">حذف رویداد</button>
                        <div class="flex gap-4">
                            <button type="button" id="cancel-btn"
                                class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">انصراف</button>
                            <button type="submit" class="btn-gold">ذخیره</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="notification-toast"
        class="fixed bottom-5 left-5 bg-white rounded-lg shadow-2xl p-5 w-80 border-t-4 border-[var(--gold)] transition-transform duration-500 translate-x-[-120%]"
        style="z-index: 100;">
        <div class="flex items-start gap-4">
            <i class="fa-solid fa-bell text-2xl text-[var(--gold)] mt-1"></i>
            <div>
                <h3 class="font-display text-lg text-slate-800">کارهای امروز شما</h3>
                <div id="toast-task-list" class="text-sm text-slate-600 mt-2 space-y-1"></div>
            </div>
            <button onclick="document.getElementById('notification-toast').classList.remove('show')"
                class="text-slate-400 hover:text-slate-600">&times;</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalali-moment@3.3.11/dist/jalali-moment.browser.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- 1. SUPABASE CLIENT & ALL DOM ELEMENTS ---
            const SUPABASE_URL = 'https://evfgzegtplkhocfxcjpp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2Zmd6ZWd0cGxraG9jZnhjanBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDgyOTUsImV4cCI6MjA3NDcyNDI5NX0.eUDSqjhSK7Tk8rHfXV_tFTBzGbT3jBHJnLG70WVpV44';
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { storage: window.sessionStorage } });

            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.getElementById('user-menu');
            const profileToggleBtn = document.getElementById('profile-toggle-btn');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const logoutBtn = document.getElementById('logout-btn');
            const monthDisplay = document.getElementById('month-display');
            const daysGrid = document.getElementById('calendar-days-grid');
            const detailsList = document.getElementById('details-list');
            // ... (سایر DOM elements)

            // --- 2. STATE VARIABLES ---
            let currentMoment = moment();
            let allPublicEvents = [];
            let userPersonalEvents = [];
            let isPremiumUser = false;

            // --- 3. AUTHENTICATION & INITIALIZATION ---
            moment.locale('fa');

            _supabase.auth.onAuthStateChange(async (event, session) => {
                if (session && session.user) {
                    loginBtn.style.display = 'none';
                    userMenu.style.display = 'block';
                } else {
                    loginBtn.style.display = 'flex';
                    userMenu.style.display = 'none';
                }
                // Load public events for everyone
                fetchPublicEvents(currentMoment.jYear());
            });

            // --- 4. EVENT LISTENERS ---
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentMoment.subtract(1, 'jMonth');
                fetchPublicEvents(currentMoment.jYear()); // Fetch new year's data if changed
            });

            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentMoment.add(1, 'jMonth');
                fetchPublicEvents(currentMoment.jYear()); // Fetch new year's data if changed
            });

            if (profileToggleBtn) {
                profileToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdownMenu.classList.toggle('hidden');
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await _supabase.auth.signOut();
                    sessionStorage.clear();
                    window.location.replace('index.html');
                });
            }

            window.addEventListener('click', () => {
                if (dropdownMenu && !dropdownMenu.classList.contains('hidden')) {
                    dropdownMenu.classList.add('hidden');
                }
            });


            // --- 5. CORRECTED JAVASCRIPT DATE CALCULATION LOGIC ---

            const officialHolidays = [
                { date: '1404-01-01', title: 'جشن نوروز', isHoliday: true },
                { date: '1404-01-02', title: 'جشن نوروز', isHoliday: true },
                { date: '1404-01-03', title: 'جشن نوروز', isHoliday: true },
                { date: '1404-01-04', title: 'جشن نوروز', isHoliday: true },
                { date: '1404-01-12', title: 'روز جمهوری اسلامی', isHoliday: true },
                { date: '1404-01-13', title: 'روز طبیعت', isHoliday: true },
                { date: '1404-03-14', title: 'رحلت امام خمینی', isHoliday: true },
                { date: '1404-03-15', title: 'قیام ۱۵ خرداد', isHoliday: true },
                { date: '1404-11-22', title: 'پیروزی انقلاب اسلامی', isHoliday: true },
                { date: '1404-12-29', title: 'روز ملی شدن صنعت نفت', isHoliday: true },
            ];

            function adjustForWeekend(gregorianDate) {
                // Friday is day 5 in jalali-moment's day() for Persian calendar (Saturday is 6, Sunday is 0)
                if (gregorianDate.day() === 5) {
                    return gregorianDate.add(1, 'days');
                }
                return gregorianDate;
            }

            // FIX: Replaced all `moment.jMoment` with `moment`
            function calculateEventsFromRules(rules, year) {
                let finalEvents = [];
                rules.forEach(rule => {
                    try {
                        switch (rule.rule_type) {
                            case 'DAYS_AFTER_QUARTER_END':
                                [3, 6, 9, 12].forEach(month => {
                                    const day = (month <= 6) ? 31 : (month < 12 ? 30 : 29); // Simplified for non-leap year
                                    const endOfQuarter = moment(`${year}/${month}/${day}`, 'jYYYY/jM/jD');
                                    if (!endOfQuarter.isValid()) return;
                                    const eventDate = endOfQuarter.add(parseInt(rule.rule_value), 'days');
                                    const adjustedDate = adjustForWeekend(eventDate);
                                    finalEvents.push({
                                        title: `${rule.event_name} - فصل ${moment(`${year}/${month}/1`, 'jYYYY/jM/jD').format('jMMMM')}`,
                                        date: adjustedDate.format('YYYY-MM-DD')
                                    });
                                });
                                break;
                            case 'END_OF_MONTH':
                                for (let m = 1; m <= 12; m++) {
                                    let currentMonth = moment(`${year}/${m}/1`, 'jYYYY/jM/jD');
                                    if (!currentMonth.isValid()) continue;
                                    let endOfNextMonth = currentMonth.clone().add(1, 'jMonth').endOf('jMonth');
                                    let adjustedDate = adjustForWeekend(endOfNextMonth);
                                    finalEvents.push({
                                        title: `${rule.event_name} (مربوط به ${currentMonth.format('jMMMM')})`,
                                        date: adjustedDate.format('YYYY-MM-DD')
                                    });
                                }
                                break;
                            case 'DAYS_AFTER_YEAR_END':
                                const yearEnd = moment(`${year}/12/29`, 'jYYYY/jM/jD'); // Assuming non-leap year
                                if (!yearEnd.isValid()) break;
                                const eventDate = yearEnd.add(parseInt(rule.rule_value), 'days');
                                const adjustedDate = adjustForWeekend(eventDate);
                                finalEvents.push({ title: rule.event_name, date: adjustedDate.format('YYYY-MM-DD') });
                                break;
                            case 'FIXED_SHAMSI_DATE':
                                const [month, day] = rule.rule_value.split('-');
                                const fixedDate = moment(`${year}/${month}/${day}`, 'jYYYY/jM/jD');
                                if (!fixedDate.isValid()) break;
                                const adjustedFixedDate = adjustForWeekend(fixedDate);
                                finalEvents.push({ title: rule.event_name, date: adjustedFixedDate.format('YYYY-MM-DD') });
                                break;
                        }
                    } catch (e) {
                        console.error("Error processing rule:", rule, e);
                    }
                });
                return finalEvents;
            }

            // --- 6. UPDATED DATA FETCHING LOGIC ---
            async function fetchPublicEvents(year) {
                let ruleBasedEvents = [];
                try {
                    const { data: rules, error } = await _supabase.from('public_event_rules').select('*');
                    if (error) throw error;
                    ruleBasedEvents = calculateEventsFromRules(rules, year);
                } catch (error) {
                    console.error("Could not load or calculate public events:", error);
                }

                allPublicEvents = [...ruleBasedEvents, ...officialHolidays];
                allPublicEvents.sort((a, b) => a.date.localeCompare(b.date));

                renderCalendar();
            }

            // --- 7. RENDER & OTHER FUNCTIONS ---
            function renderCalendar() {
                if (!daysGrid) return;
                daysGrid.innerHTML = '';
                monthDisplay.textContent = currentMoment.format('jMMMM jYYYY');

                const startOfMonth = currentMoment.clone().startOf('jMonth');
                const endOfMonth = currentMoment.clone().endOf('jMonth');

                const daysInMonth = currentMoment.jDaysInMonth();
                const firstDayOfWeek = startOfMonth.day(); // 6 for Saturday in Persian locale

                // Add empty cells for days before the first day of the month
                const offset = (firstDayOfWeek === 6) ? 0 : firstDayOfWeek + 1;
                for (let i = 0; i < offset; i++) {
                    daysGrid.innerHTML += `<div class="day-cell other-month"></div>`;
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayMoment = moment(startOfMonth).add(i - 1, 'days');
                    const dateString = dayMoment.format('YYYY-MM-DD');

                    const publicEvents = allPublicEvents.filter(e => e.date === dateString);
                    const isHoliday = publicEvents.some(e => e.isHoliday);
                    const isToday = dayMoment.isSame(moment(), 'day');

                    let cellClasses = 'day-cell';
                    if (isToday) cellClasses += ' today';
                    if (isHoliday) cellClasses += ' holiday-cell'; // You can style this class in CSS

                    let eventsHtml = '';
                    publicEvents.slice(0, 2).forEach(event => {
                        eventsHtml += `<div class="event-title-inline ${event.isHoliday ? 'bg-red-600' : ''}">${event.title}</div>`;
                    });

                    if (publicEvents.length > 2) {
                        eventsHtml += `<div class="text-xs text-center mt-1 text-slate-500">+${publicEvents.length - 2} مورد دیگر</div>`;
                    }

                    const dayCellHtml = `
                    <div class="${cellClasses}" data-date="${dateString}">
                        <div class="day-number">${i}</div>
                        <div class="day-events-list">${eventsHtml}</div>
                    </div>
                `;
                    daysGrid.innerHTML += dayCellHtml;
                }

                // Attach event listeners to new cells
                document.querySelectorAll('.day-cell[data-date]').forEach(cell => {
                    cell.addEventListener('click', handleDayClick);
                });

                // Select today by default
                const todayCell = document.querySelector(`.day-cell[data-date="${moment().format('YYYY-MM-DD')}"]`);
                if (todayCell) {
                    handleDayClick({ currentTarget: todayCell });
                }
            }

            function handleDayClick(e) {
                document.querySelectorAll('.day-cell.selected').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                const date = e.currentTarget.dataset.date;

                const publicEvents = allPublicEvents.filter(ev => ev.date === date);

                detailsList.innerHTML = ''; // Clear previous details

                if (publicEvents.length > 0) {
                    publicEvents.forEach(event => {
                        const li = document.createElement('li');
                        li.textContent = event.title;
                        if (event.isHoliday) li.classList.add('font-bold', 'text-red-600');
                        detailsList.appendChild(li);
                    });
                } else {
                    detailsList.innerHTML = '<li>رویدادی برای این روز ثبت نشده است.</li>';
                }
            }

            // --- Initial Data Load ---
            fetchPublicEvents(currentMoment.jYear());
        });
        // --- START: Live Clock Logic for Header and Widget ---

        // Find clock elements on the page
        const headerClockEl = document.getElementById('live-clock-display');
        const widgetTimeEl = document.getElementById('widget-time');
        const shamsiDateEl = document.getElementById('widget-shamsi-date');
        const qamariDateEl = document.getElementById('widget-qamari-date');
        const gregorianDateEl = document.getElementById('widget-gregorian-date');

        function updateLiveClocks() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fa-IR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // Update the header clock if it exists
            if (headerClockEl) {
                headerClockEl.textContent = timeString;
            }

            // Update the main widget clock if it exists
            if (widgetTimeEl) {
                widgetTimeEl.textContent = timeString;
            }

            // Update the date parts of the widget if they exist
            if (shamsiDateEl) {
                shamsiDateEl.textContent = new Intl.DateTimeFormat('fa-IR', {
                    day: 'numeric',
                    month: 'long'
                }).format(now);
            }
            if (gregorianDateEl) {
                gregorianDateEl.textContent = new Intl.DateTimeFormat('en-US', {
                    month: 'long',
                    day: 'numeric'
                }).format(now);
            }
            if (qamariDateEl) {
                try {
                    qamariDateEl.textContent = new Intl.DateTimeFormat('fa-IR-u-ca-islamic', {
                        day: 'numeric',
                        month: 'long'
                    }).format(now);
                } catch (e) {
                    qamariDateEl.textContent = 'ناموجود';
                }
            }
        }

        // Run the clock update function every second
        if (headerClockEl || widgetTimeEl) {
            updateLiveClocks(); // Call it once immediately
            setInterval(updateLiveClocks, 1000); // Then update every second
        }

        // --- END: Live Clock Logic ---
    </script>
</body>

</html>