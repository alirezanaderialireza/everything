<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقویم هفتگی - آیدا شیرازی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Vazirmatn:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --navy: #0A192F;
            --slate-800: #1e293b;
            --slate-600: #475569;
            --slate-100: #f1f5f9;
            --gold: #c49827;
            --light-gold: #FBEFCE;
            --font-display: 'Lalezar', cursive;
            --font-body: 'Vazirmatn', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--slate-100);
        }

        h1,
        h2,
        .font-display {
            font-family: var(--font-display);
        }

        .main-header {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-link {
            transition: color 0.3s ease;
            color: var(--slate-800);
            font-weight: 500;
        }

        .nav-link:hover {
            color: var(--navy);
        }

        .btn-gold {
            background-color: var(--gold);
            color: var(--navy);
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            transition: all 0.2s;
        }

        .btn-gold:hover:not(:disabled) {
            background-color: #b98d1e;
            transform: translateY(-2px);
        }

        #calendar-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--navy);
            color: white;
        }

        .week-title-display {
            font-family: var(--font-display);
            font-size: 1.75rem;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .today-btn {
            background: rgba(255, 255, 255, 0.9);
            color: var(--navy);
            border-radius: 6px;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            margin: 0 0.5rem;
        }

        .day-header-cell {
            text-align: center;
            padding: 0.75rem 0.25rem;
            font-weight: 600;
            color: var(--slate-600);
            background-color: var(--slate-100);
            border-left: 1px solid #e2e8f0;
        }

        .day-header-cell:last-child {
            border-left: none;
        }

        .day-header-cell.today .day-number-weekly {
            background-color: var(--gold);
            color: white;
        }

        .day-number-weekly {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: 700;
            margin-top: 4px;
        }

        .time-label {
            text-align: center;
            font-size: 0.75rem;
            color: var(--slate-500);
            position: relative;
            top: -8px;
        }

        #time-labels-container {
            border-left: 1px solid #e2e8f0;
        }

        .day-column {
            border-left: 1px solid #e2e8f0;
            position: relative;
        }

        .day-column:last-child {
            border-left: none;
        }

        #all-day-events-container .day-column {
            border-bottom: 1px solid #e2e8f0;
        }

        .hour-line {
            height: 60px;
            border-top: 1px dotted #d1d5db;
        }

        .event-block,
        .all-day-event-block {
            color: white;
            border-radius: 6px;
            padding: 4px 8px;
            overflow: hidden;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-right: 3px solid rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            cursor: pointer;
        }

        .event-block:hover,
        .all-day-event-block:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .event-block {
            position: absolute;
            right: 4px;
            left: 4px;
        }

        .all-day-event-block {
            margin: 2px;
            font-weight: 500;
        }

        #event-modal {
            transition: opacity 0.3s ease;
        }

        .category-selector input[type="radio"] {
            display: none;
        }

        .category-selector label {
            padding: 6px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-selector input[type="radio"]:checked+label {
            background-color: var(--cat-color);
            color: white;
            border-color: var(--cat-color);
        }
    </style>
</head>

<body class="bg-slate-100">

    <header class="main-header sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://i.postimg.cc/j519gM1p/dd6fd5aa-9d3e-4a23-85e5-5ee9a534197e.jpg" alt="لوگو"
                    class="w-10 h-10 rounded-full">
                <a href="index.html" class="text-xl font-bold font-display" style="color: var(--navy);">آیدا شیرازی</a>
            </div>
            <div class="hidden md:flex items-center space-x-10 space-x-reverse">
                <a href="index.html#roadmap" class="nav-link">نقشه راه</a>
                <a href="documents.html" class="nav-link">اسناد حسابداری</a>
                <a href="calendar.html" class="nav-link">تقویم هوشمند</a>
                <a href="calculator.html" class="nav-link">ماشین حساب</a>
                <a href="index.html#updates" class="nav-link">آخرین تغییرات</a>
                <a href="index.html#about" class="nav-link">درباره من</a>
            </div>
            <div id="profile-section" class="relative">
                <a href="login.html" id="login-btn" class="btn-gold flex items-center justify-center gap-2 px-4 py-2">
                    <i class="fa-solid fa-right-to-bracket"></i>
                    <span>ورود / ثبت‌نام</span>
                </a>
                <div id="user-menu" class="hidden">
                    <button id="profile-toggle-btn"
                        class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--gold)]">
                        <i class="fa-solid fa-user text-slate-600"></i>
                    </button>
                    <div id="dropdown-menu"
                        class="hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-50">
                        <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">تنظیمات
                            پروفایل</a>
                        <a href="#" id="logout-btn"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">خروج</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-6 mt-8">
        <div class="flex justify-end mb-6">
            <button id="add-event-btn" class="btn-gold"><i class="fa-solid fa-plus ml-2"></i><span>افزودن
                    رویداد</span></button>
        </div>

        <div id="calendar-wrapper">
            <div class="calendar-header">
                <button id="prev-week-btn" class="calendar-nav-btn"><i class="fa fa-chevron-right"></i></button>
                <div class="flex items-center">
                    <h1 id="week-title" class="week-title-display"></h1>
                    <button id="today-btn" class="today-btn">امروز</button>
                </div>
                <button id="next-week-btn" class="calendar-nav-btn"><i class="fa fa-chevron-left"></i></button>
            </div>

            <div id="weekly-container" class="grid grid-cols-[80px_1fr]">
                <div>
                    <div class="h-[88px] bg-slate-100"></div>
                    <div class="text-center font-semibold text-xs py-2 h-12 border-t border-l border-slate-200">تمام روز
                    </div>
                    <div id="time-labels-container"></div>
                </div>

                <div class="overflow-x-auto">
                    <div id="day-headers" class="grid grid-cols-7 h-[88px]"></div>
                    <div id="all-day-events-container" class="grid grid-cols-7 h-12"></div>
                    <div class="relative" style="height: calc(16 * 60px);">
                        <div id="timeline-grid" class="grid grid-cols-7 h-full"></div>
                        <div id="current-time-indicator" class="hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-display text-[var(--navy)] mb-6">ثبت رویداد جدید</h2>
            <form id="event-form" class="space-y-4">
                <input type="hidden" id="event-id">
                <div>
                    <label for="event-title" class="text-sm font-medium text-slate-700">عنوان رویداد</label>
                    <input id="event-title" type="text" required
                        class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-[var(--gold)] outline-none">
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">دسته‌بندی</label>
                    <div class="category-selector mt-1 flex flex-wrap gap-2">
                        <input type="radio" name="category" id="cat-meeting"
                            value='{"name": "جلسه", "color": "#0A192F"}' checked><label for="cat-meeting"
                            style="--cat-color: #0A192F;">جلسه</label>
                        <input type="radio" name="category" id="cat-deadline"
                            value='{"name": "مهلت قانونی", "color": "#ef4444"}'><label for="cat-deadline"
                            style="--cat-color: #ef4444;">مهلت قانونی</label>
                        <input type="radio" name="category" id="cat-personal"
                            value='{"name": "شخصی", "color": "#22c55e"}'><label for="cat-personal"
                            style="--cat-color: #22c55e;">شخصی</label>
                        <input type="radio" name="category" id="cat-reminder"
                            value='{"name": "یادآوری", "color": "#c49827"}'><label for="cat-reminder"
                            style="--cat-color: #c49827;">یادآوری</label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-date" class="text-sm font-medium text-slate-700">تاریخ</label>
                        <input id="event-date" type="date" required class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div class="flex items-center pt-6">
                        <input id="is-all-day" type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]">
                        <label for="is-all-day" class="mr-2 text-sm font-medium text-slate-700">تمام روز</label>
                    </div>
                </div>
                <div id="time-inputs" class="grid grid-cols-2 gap-4">
                    <div><label for="start-time" class="text-sm font-medium text-slate-700">ساعت شروع</label><input
                            id="start-time" type="time" required class="mt-1 w-full p-2 border rounded-md"></div>
                    <div><label for="end-time" class="text-sm font-medium text-slate-700">ساعت پایان</label><input
                            id="end-time" type="time" required class="mt-1 w-full p-2 border rounded-md"></div>
                </div>
                <div class="border-t pt-4 flex items-center">
                    <input id="is-recurring" type="checkbox"
                        class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]">
                    <label for="is-recurring" class="mr-2 text-sm font-bold text-slate-800">رویداد تکرارشونده</label>
                </div>
                <div id="recurring-options" class="hidden space-y-4 p-4 bg-slate-50 rounded-lg border">
                    <div>
                        <label class="text-sm font-medium text-slate-700 mb-2 block">تکرار در روزهای:</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2" id="weekday-selector"></div>
                    </div>
                    <div>
                        <label for="end-date" class="text-sm font-medium text-slate-700">تاریخ پایان تکرار</label>
                        <input id="end-date" type="date" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                </div>
                <div class="border-t pt-4 flex items-center">
                    <input id="show-on-dashboard" type="checkbox"
                        class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]" checked>
                    <label for="show-on-dashboard" class="mr-2 text-sm font-medium text-slate-700">نمایش در ویجت صفحه
                        اصلی</label>
                </div>
                <div class="pt-4 flex justify-between items-center">
                    <button type="button" id="delete-event-btn"
                        class="px-4 py-2 rounded-md text-red-600 hover:bg-red-50 hidden">حذف رویداد</button>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-btn"
                            class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">انصراف</button>
                        <button type="submit" class="btn-gold">ذخیره</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalali-moment@3.3.11/dist/jalali-moment.browser.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- SUPABASE & DOM ELEMENTS ---
            const SUPABASE_URL = 'https://evfgzegtplkhocfxcjpp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2Zmd6ZWd0cGxraG9jZnhjanBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDgyOTUsImV4cCI6MjA3NDcyNDI5NX0.eUDSqjhSK7Tk8rHfXV_tFTBzGbT3jBHJnLG70WVpV44';
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { storage: window.sessionStorage } });

            const dayHeadersContainer = document.getElementById('day-headers');
            const allDayContainer = document.getElementById('all-day-events-container');
            const timeLabelsContainer = document.getElementById('time-labels-container');
            const timelineGrid = document.getElementById('timeline-grid');
            const weekTitleEl = document.getElementById('week-title');
            const modal = document.getElementById('event-modal');
            const modalTitle = document.getElementById('modal-title');
            const addEventBtn = document.getElementById('add-event-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const eventForm = document.getElementById('event-form');
            const eventDateInput = document.getElementById('event-date');
            const endDateInput = document.getElementById('end-date');
            const isAllDayCheckbox = document.getElementById('is-all-day');
            const timeInputs = document.getElementById('time-inputs');
            const deleteEventBtn = document.getElementById('delete-event-btn');
            const isRecurringCheckbox = document.getElementById('is-recurring');
            const recurringOptions = document.getElementById('recurring-options');
            const weekdaySelector = document.getElementById('weekday-selector');
            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.getElementById('user-menu');
            const profileToggleBtn = document.getElementById('profile-toggle-btn');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const logoutBtn = document.getElementById('logout-btn');
            let currentUser = null;
            let currentMoment = moment();
            moment.locale('fa');

            const officialHolidays = [{ date: '1404-01-01', title: 'جشن نوروز', isHoliday: true }, { date: '1404-01-02', title: 'جشن نوروز', isHoliday: true }, { date: '1404-01-03', title: 'جشن نوروز', isHoliday: true }, { date: '1404-01-04', title: 'جشن نوروز', isHoliday: true }, { date: '1404-01-12', title: 'روز جمهوری اسلامی', isHoliday: true }, { date: '1404-01-13', title: 'روز طبیعت', isHoliday: true }, { date: '1404-03-14', title: 'رحلت امام خمینی', isHoliday: true }, { date: '1404-03-15', title: 'قیام ۱۵ خرداد', isHoliday: true }, { date: '1404-11-22', title: 'پیروزی انقلاب اسلامی', isHoliday: true }, { date: '1404-12-29', title: 'روز ملی شدن صنعت نفت', isHoliday: true },];
            function adjustForWeekend(gregorianDate) { if (gregorianDate.day() === 5) return gregorianDate.add(1, 'days'); return gregorianDate; }
            function calculateEventsFromRules(rules, year) { let finalEvents = []; rules.forEach(rule => { try { switch (rule.rule_type) { case 'DAYS_AFTER_QUARTER_END': [3, 6, 9, 12].forEach(month => { const day = (month <= 6) ? 31 : (month < 12 ? 30 : 29); const endOfQuarter = moment(`${year}/${month}/${day}`, 'jYYYY/jM/jD'); if (!endOfQuarter.isValid()) return; const eventDate = endOfQuarter.add(parseInt(rule.rule_value), 'days'); const adjustedDate = adjustForWeekend(eventDate); finalEvents.push({ title: `${rule.event_name} - فصل ${moment(`${year}/${month}/1`, 'jYYYY/jM/jD').format('jMMMM')}`, date: adjustedDate.format('YYYY-MM-DD') }); }); break; case 'END_OF_MONTH': for (let m = 1; m <= 12; m++) { let currentMonth = moment(`${year}/${m}/1`, 'jYYYY/jM/jD'); if (!currentMonth.isValid()) continue; let endOfNextMonth = currentMonth.clone().add(1, 'jMonth').endOf('jMonth'); let adjustedDate = adjustForWeekend(endOfNextMonth); finalEvents.push({ title: `${rule.event_name} (مربوط به ${currentMonth.format('jMMMM')})`, date: adjustedDate.format('YYYY-MM-DD') }); } break; case 'DAYS_AFTER_YEAR_END': const yearEnd = moment(`${year}/12/29`, 'jYYYY/jM/jD'); if (!yearEnd.isValid()) break; const eventDate = yearEnd.add(parseInt(rule.rule_value), 'days'); const adjustedDate = adjustForWeekend(eventDate); finalEvents.push({ title: rule.event_name, date: adjustedDate.format('YYYY-MM-DD') }); break; case 'FIXED_SHAMSI_DATE': const [month, day] = rule.rule_value.split('-'); const fixedDate = moment(`${year}/${month}/${day}`, 'jYYYY/jM/jD'); if (!fixedDate.isValid()) break; const adjustedFixedDate = adjustForWeekend(fixedDate); finalEvents.push({ title: rule.event_name, date: adjustedFixedDate.format('YYYY-MM-DD') }); break; } } catch (e) { console.error("Error processing rule:", rule, e); } }); return finalEvents; }
            function timeToMinutes(timeStr) { if (!timeStr) return 0; const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; }

            _supabase.auth.onAuthStateChange(async (event, session) => {
                if (session && session.user) {
                    currentUser = session.user;
                    loginBtn.style.display = 'none'; userMenu.style.display = 'block';
                    const { data: profile } = await _supabase.from('profiles').select('has_premium_calendar').eq('id', currentUser.id).single();
                    if (!profile || !profile.has_premium_calendar) { alert('دسترسی به این بخش نیازمند خرید تقویم پیشرفته است.'); window.location.href = 'calendar.html'; return; }
                    setupWeekView(currentMoment);
                } else { window.location.href = 'login.html'; }
            });

            if (profileToggleBtn) profileToggleBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('hidden'); });
            if (logoutBtn) logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await _supabase.auth.signOut(); sessionStorage.clear(); window.location.replace('index.html'); });
            window.addEventListener('click', () => { if (dropdownMenu && !dropdownMenu.classList.contains('hidden')) dropdownMenu.classList.add('hidden'); });
            document.getElementById('prev-week-btn').addEventListener('click', () => { currentMoment = currentMoment.clone().subtract(7, 'days'); setupWeekView(currentMoment); });
            document.getElementById('next-week-btn').addEventListener('click', () => { currentMoment = currentMoment.clone().add(7, 'days'); setupWeekView(currentMoment); });
            document.getElementById('today-btn').addEventListener('click', () => { currentMoment = moment(); setupWeekView(currentMoment); });

            async function setupWeekView(date) { /* ... same as before ... */ }
            async function loadAndRenderAllEvents(date) { /* ... same as before ... */ }
            function renderPublicEvent(event) { /* ... same as before ... */ }
            function renderPersonalEvent(event) { /* ... same as before ... */ }

            // --- CORRECTED: Modal opening functions ---
            function openAddModal(date) {
                modalTitle.textContent = 'ثبت رویداد جدید';
                eventForm.reset();
                eventDateInput.value = moment(date, 'YYYY-MM-DD').format('jYYYY/jMM/jDD'); // Set value in standard Jalali format
                const defaultEndDate = moment(date, 'YYYY-MM-DD').add(1, 'month').format('jYYYY/jMM/jDD');
                endDateInput.value = defaultEndDate;
                document.getElementById('show-on-dashboard').checked = true;
                isRecurringCheckbox.checked = false; isRecurringCheckbox.disabled = false;
                timeInputs.style.display = 'grid';
                eventForm['start-time'].required = true; eventForm['end-time'].required = true;
                recurringOptions.classList.add('hidden');
                endDateInput.required = false;
                deleteEventBtn.classList.add('hidden');
                modal.classList.remove('hidden');
            }

            function openEditModal(event) {
                modalTitle.textContent = 'ویرایش رویداد';
                eventForm.reset();
                isRecurringCheckbox.checked = false; isRecurringCheckbox.disabled = true;
                recurringOptions.classList.add('hidden');
                eventForm['event-id'].value = event.id;
                eventForm['event-title'].value = event.title;
                eventDateInput.value = moment(event.event_date, 'YYYY-MM-DD').format('jYYYY/jMM/jDD');
                const defaultEndDate = moment(event.event_date, 'YYYY-MM-DD').add(1, 'month').format('jYYYY/jMM/jDD');
                endDateInput.value = defaultEndDate;
                document.getElementById('show-on-dashboard').checked = event.show_on_dashboard;
                const categoryRadio = document.querySelector(`input[name="category"][value*='"color": "${event.color}"']`);
                if (categoryRadio) categoryRadio.checked = true;
                isAllDayCheckbox.checked = event.is_all_day;
                if (event.is_all_day) { timeInputs.style.display = 'none'; eventForm['start-time'].required = false; eventForm['end-time'].required = false; }
                else { timeInputs.style.display = 'grid'; eventForm['start-time'].required = true; eventForm['end-time'].required = true; eventForm['start-time'].value = event.start_time; eventForm['end-time'].value = event.end_time; }
                deleteEventBtn.classList.remove('hidden');
                modal.classList.remove('hidden');
            }

            addEventBtn.addEventListener('click', () => openAddModal(moment().format('YYYY-MM-DD')));
            cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
            isAllDayCheckbox.addEventListener('change', (e) => { const isChecked = e.target.checked; timeInputs.style.display = isChecked ? 'none' : 'grid'; eventForm['start-time'].required = !isChecked; eventForm['end-time'].required = !isChecked; });
            isRecurringCheckbox.addEventListener('change', (e) => { recurringOptions.classList.toggle('hidden', !e.target.checked); endDateInput.required = e.target.checked; });
            const days = [{ fa: 'شنبه', val: '6' }, { fa: 'یکشنبه', val: '0' }, { fa: 'دوشنبه', val: '1' }, { fa: 'سه‌شنبه', val: '2' }, { fa: 'چهارشنبه', val: '3' }, { fa: 'پنجشنبه', val: '4' }, { fa: 'جمعه', val: '5' }];
            weekdaySelector.innerHTML = days.map(day => `<div class="flex items-center"><input type="checkbox" id="day-${day.val}" value="${day.val}" class="form-checkbox h-4 w-4"><label for="day-${day.val}" class="mr-2 text-sm">${day.fa}</label></div>`).join('');
            deleteEventBtn.addEventListener('click', async () => { /* ... same as before ... */ });

            // --- FINAL CORRECTED: Event Form Submission Logic ---
            eventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'در حال ذخیره...';

                try {
                    if (!currentUser || !currentUser.id) throw new Error('کاربر شناسایی نشد.');

                    const eventId = e.target['event-id'].value;
                    const categoryData = JSON.parse(e.target['category'].value);
                    const isRecurring = isRecurringCheckbox.checked;

                    // --- FINAL FIX: Use the correct format 'jYYYY/jMM/jDD' to parse ---
                    const gregorianDate = moment(e.target['event-date'].value, 'jYYYY/jMM/jDD').format('YYYY-MM-DD');
                    if (!moment(gregorianDate).isValid()) throw new Error('فرمت تاریخ شروع نامعتبر است. لطفاً تاریخ را به صورت YYYY/MM/DD وارد کنید.');

                    let response;

                    if (isRecurring && !eventId) {
                        const gregorianEndDate = moment(e.target['end-date'].value, 'jYYYY/jMM/jDD').format('YYYY-MM-DD');
                        if (!moment(gregorianEndDate).isValid()) throw new Error('فرمت تاریخ پایان تکرار نامعتبر است.');

                        const startDate = moment(gregorianDate);
                        const endDate = moment(gregorianEndDate);
                        const selectedWeekdays = Array.from(weekdaySelector.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));

                        if (selectedWeekdays.length === 0 || !endDate.isAfter(startDate)) {
                            throw new Error('لطفا روزهای هفته و تاریخ پایان معتبر را انتخاب کنید.');
                        }

                        const eventsToInsert = [];
                        let currentDay = startDate.clone();
                        while (currentDay.isSameOrBefore(endDate)) {
                            if (selectedWeekdays.includes(currentDay.day())) {
                                eventsToInsert.push({ title: e.target['event-title'].value, event_date: currentDay.format('YYYY-MM-DD'), is_all_day: e.target['is-all-day'].checked, category: categoryData.name, color: categoryData.color, start_time: e.target['is-all-day'].checked ? null : e.target['start-time'].value, end_time: e.target['is-all-day'].checked ? null : e.target['end-time'].value, show_on_dashboard: document.getElementById('show-on-dashboard').checked, user_id: currentUser.id, is_completed: false });
                            }
                            currentDay.add(1, 'day');
                        }
                        if (eventsToInsert.length > 0) {
                            response = await _supabase.from('user_personal_events').insert(eventsToInsert).select();
                        }
                    } else {
                        const eventData = { title: e.target['event-title'].value, event_date: gregorianDate, is_all_day: e.target['is-all-day'].checked, category: categoryData.name, color: categoryData.color, start_time: e.target['is-all-day'].checked ? null : e.target['start-time'].value, end_time: e.target['is-all-day'].checked ? null : e.target['end-time'].value, show_on_dashboard: document.getElementById('show-on-dashboard').checked, user_id: currentUser.id, is_completed: false };
                        if (eventId) {
                            response = await _supabase.from('user_personal_events').update(eventData).eq('id', eventId).select();
                        } else {
                            response = await _supabase.from('user_personal_events').insert([eventData]).select();
                        }
                    }

                    if (response && response.error) throw response.error;

                    modal.classList.add('hidden');
                    setupWeekView(currentMoment);

                } catch (error) {
                    console.error("Save Error:", error);
                    alert(`خطا در ذخیره سازی: ${error.message}`);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'ذخیره';
                }
            });

            // --- Placeholder for other functions ---
            async function setupWeekView(date) {
                let startOfWeek = date.clone().startOf('jWeek'); weekTitleEl.textContent = `هفته ${startOfWeek.format('jD jMMMM')}`; let headersHtml = '', allDayColsHtml = '', timelineColsHtml = ''; for (let i = 0; i < 7; i++) { let dayMoment = startOfWeek.clone().add(i, 'days'); let isToday = dayMoment.isSame(moment(), 'day'); let dateStr = dayMoment.format('YYYY-MM-DD'); headersHtml += `<div class="day-header-cell ${isToday ? 'today' : ''}" data-date="${dateStr}"><span class="day-name">${dayMoment.format('dddd')}</span><div class="day-number-weekly">${dayMoment.format('jD')}</div></div>`; allDayColsHtml += `<div id="all-day-col-${dateStr}" class="day-column p-1 space-y-1" data-date="${dateStr}"></div>`; timelineColsHtml += `<div id="day-col-${dateStr}" class="day-column" data-date="${dateStr}">${Array(16).fill('<div class="hour-line"></div>').join('')}</div>` }
                dayHeadersContainer.innerHTML = headersHtml; allDayContainer.innerHTML = allDayColsHtml; timelineGrid.innerHTML = timelineColsHtml; let timeLabelsHtml = ''; for (let i = 8; i <= 23; i++) { timeLabelsHtml += `<div class="time-label h-[60px]">${i}:00</div>` }
                timeLabelsContainer.innerHTML = timeLabelsHtml; document.querySelectorAll('.day-column, .day-header-cell').forEach(cell => { cell.addEventListener('click', e => { if (e.target.closest('.event-block') || e.target.closest('.all-day-event-block')) return; let date = cell.dataset.date; if (date) { openAddModal(date) } }) }); await loadAndRenderAllEvents(date)
            }
            async function loadAndRenderAllEvents(date) {
                let startOfWeek = date.clone().startOf('jWeek'), endOfWeek = date.clone().endOf('jWeek'); let ruleBasedEvents = []; try { let { data: rules, error } = await _supabase.from('public_event_rules').select('*'); if (error) throw error; ruleBasedEvents = calculateEventsFromRules(rules, date.jYear()) } catch (error) { console.error(error) }
                let allPublicEventsForYear = [...ruleBasedEvents, ...officialHolidays]; let weekPublicEvents = allPublicEventsForYear.filter(e => moment(e.date, 'YYYY-MM-DD').isBetween(startOfWeek, endOfWeek, 'day', '[]')); weekPublicEvents.forEach(renderPublicEvent); let { data, error } = await _supabase.from('user_personal_events').select('*').eq('user_id', currentUser.id).gte('event_date', startOfWeek.format('YYYY-MM-DD')).lte('event_date', endOfWeek.format('YYYY-MM-DD')); if (error) return console.error("Error fetching personal events:", error); data.forEach(renderPersonalEvent)
            }
            function renderPublicEvent(event) { let dayColumn = document.getElementById(`all-day-col-${event.date}`); if (!dayColumn) return; let eventElement = document.createElement('div'); eventElement.className = 'all-day-event-block'; eventElement.style.backgroundColor = event.isHoliday ? '#ef4444' : 'var(--navy)'; eventElement.textContent = event.title; dayColumn.appendChild(eventElement) }
            function renderPersonalEvent(event) {
                let eventElement = document.createElement('div'); eventElement.dataset.eventId = event.id; eventElement.style.backgroundColor = event.color; if (event.is_all_day) { eventElement.className = 'all-day-event-block'; eventElement.textContent = event.title; let dayCol = document.getElementById(`all-day-col-${event.event_date}`); if (dayCol) dayCol.appendChild(eventElement) } else { let dayColumn = document.getElementById(`day-col-${event.event_date}`); if (!dayColumn || !event.start_time || !event.end_time) return; let startMinutes = timeToMinutes(event.start_time), endMinutes = timeToMinutes(event.end_time); if (startMinutes >= endMinutes) return; let topOffset = ((startMinutes - (8 * 60)) / 60) * 60, height = ((endMinutes - startMinutes) / 60) * 60; eventElement.className = 'event-block'; eventElement.style.cssText += `top: ${topOffset}px; height: ${height}px;`; eventElement.innerHTML = `<p class="font-bold">${event.title}</p><p class="text-xs opacity-80">${event.start_time} - ${event.end_time}</p>`; dayColumn.appendChild(eventElement) }
                eventElement.addEventListener('click', () => openEditModal(event))
            }
            deleteEventBtn.addEventListener('click', async () => { const eventId = eventForm['event-id'].value; if (!eventId || !confirm('آیا از حذف رویداد مطمئن هستید؟')) return; const { error } = await _supabase.from('user_personal_events').delete().eq('id', eventId); if (error) { alert("خطا در حذف: " + error.message); } else { modal.classList.add('hidden'); setupWeekView(currentMoment); } });
        });
    </script>
</body>

</html>