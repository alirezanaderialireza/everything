<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقویم هفتگی - آیدا شیرازی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Vazirmatn:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --navy: #0A192F;
            --slate-800: #1e293b;
            --slate-600: #475569;
            --slate-100: #f1f5f9;
            --gold: #c49827;
            --light-gold: #FBEFCE;
            --font-display: 'Lalezar', cursive;
            --font-body: 'Vazirmatn', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--slate-100);
        }

        h1,
        h2,
        .font-display {
            font-family: var(--font-display);
        }

        .main-header {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-link {
            transition: color 0.3s ease;
            color: var(--slate-800);
            font-weight: 500;
        }

        .nav-link:hover {
            color: var(--navy);
        }

        .btn-gold {
            background-color: var(--gold);
            color: var(--navy);
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            transition: all 0.2s;
        }

        .btn-gold:hover:not(:disabled) {
            background-color: #b98d1e;
            transform: translateY(-2px);
        }

        .btn-gold:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* New Stylish Grid Styles */
        .header-cell {
            text-align: center;
            padding: 0.5rem 0.25rem;
            font-weight: 500;
        }

        .header-cell.today .day-name {
            color: var(--gold);
            font-weight: 700;
        }

        .header-cell.today .day-number {
            background-color: var(--gold);
            color: white;
        }

        .day-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            border-radius: 50%;
            font-size: 1rem;
            margin-top: 4px;
            font-weight: 700;
        }

        .time-label {
            text-align: center;
            font-size: 0.75rem;
            color: var(--slate-500);
            position: relative;
            top: -8px;
        }

        .day-column {
            border-left: 1px solid #e2e8f0;
            position: relative;
        }

        .day-column:last-child {
            border-left: none;
        }

        .hour-line {
            height: 60px;
            border-top: 1px dotted #d1d5db;
        }

        .event-block,
        .all-day-event-block {
            color: white;
            border-radius: 6px;
            padding: 4px 8px;
            overflow: hidden;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-right: 3px solid rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            cursor: pointer;
        }

        .event-block:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .event-block {
            position: absolute;
            right: 4px;
            left: 4px;
        }

        .all-day-event-block {
            margin-bottom: 4px;
            font-weight: 500;
        }

        #current-time-indicator {
            position: absolute;
            left: 0;
            right: 80px;
            height: 2px;
            background-color: #ef4444;
            z-index: 20;
            pointer-events: none;
            transition: top 0.5s;
        }

        #current-time-indicator::before {
            content: '';
            position: absolute;
            right: -6px;
            top: -5px;
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
        }

        /* Modal Styles */
        #event-modal {
            transition: opacity 0.3s ease;
        }

        .category-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .category-selector input[type="radio"] {
            display: none;
        }

        .category-selector label {
            padding: 6px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-selector input[type="radio"]:checked+label {
            background-color: var(--cat-color);
            color: white;
            border-color: var(--cat-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-slate-100">

    <header class="main-header sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://i.postimg.cc/j519gM1p/dd6fd5aa-9d3e-4a23-85e5-5ee9a534197e.jpg" alt="لوگو"
                    class="w-10 h-10 rounded-full">
                <a href="index.html" class="text-xl font-bold font-display" style="color: var(--navy);">آیدا شیرازی</a>
            </div>
            <div class="hidden md:flex items-center space-x-10 space-x-reverse">
                <a href="index.html#roadmap" class="nav-link">نقشه راه</a>
                <a href="documents.html" class="nav-link">اسناد حسابداری</a>
                <a href="calendar.html" class="nav-link">تقویم هوشمند</a>
                <a href="calculator.html" class="nav-link">ماشین حساب</a>
                <a href="index.html#updates" class="nav-link">آخرین تغییرات</a>
                <a href="index.html#about" class="nav-link">درباره من</a>
            </div>
            <div id="profile-section" class="relative">
                <a href="login.html" id="login-btn" class="btn-gold flex items-center justify-center gap-2 px-4 py-2">
                    <i class="fa-solid fa-right-to-bracket"></i>
                    <span>ورود / ثبت‌نام</span>
                </a>
                <div id="user-menu" class="hidden">
                    <button id="profile-toggle-btn"
                        class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--gold)]">
                        <i class="fa-solid fa-user text-slate-600"></i>
                    </button>
                    <div id="dropdown-menu"
                        class="hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-50">
                        <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">تنظیمات
                            پروفایل</a>
                        <a href="#" id="logout-btn"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">خروج</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-6 mt-8">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <h1 id="week-title" class="text-3xl md:text-4xl font-display text-[var(--navy)]"></h1>
                <div class="flex items-center gap-2">
                    <button id="prev-week-btn"
                        class="bg-white rounded-full w-9 h-9 shadow-sm hover:bg-slate-50 transition"><i
                            class="fa fa-chevron-left"></i></button>
                    <button id="next-week-btn"
                        class="bg-white rounded-full w-9 h-9 shadow-sm hover:bg-slate-50 transition"><i
                            class="fa fa-chevron-right"></i></button>
                    <button id="today-btn"
                        class="text-sm font-semibold bg-white rounded-lg px-3 py-1.5 shadow-sm hover:bg-slate-50 transition">امروز</button>
                </div>
            </div>
            <button id="add-event-btn" class="btn-gold"><i class="fa-solid fa-plus ml-2"></i><span>افزودن
                    رویداد</span></button>
        </div>

        <div id="weekly-container" class="bg-white rounded-xl shadow-xl overflow-hidden">
            <div id="day-headers" class="grid grid-cols-[80px_repeat(7,1fr)] sticky top-[65px] bg-white z-10 border-b">
            </div>
            <div id="all-day-section" class="grid grid-cols-[80px_1fr] border-b">
                <div class="text-center font-semibold text-xs py-2 border-l text-slate-500">تمام روز</div>
                <div id="all-day-events-container" class="grid grid-cols-7 relative p-1 gap-1"></div>
            </div>
            <div class="relative overflow-y-auto" style="height: calc(16 * 60px);">
                <div id="weekly-grid" class="grid grid-cols-[80px_1fr]">
                    <div id="time-labels"></div>
                    <div id="timeline-grid" class="grid grid-cols-7"></div>
                </div>
                <div id="current-time-indicator" class="hidden"></div>
            </div>
        </div>
    </main>

    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-display text-[var(--navy)] mb-6">ثبت رویداد جدید</h2>
            <form id="event-form" class="space-y-4">
                <input type="hidden" id="event-id">
                <div>
                    <label for="event-title" class="text-sm font-medium text-slate-700">عنوان رویداد</label>
                    <input id="event-title" type="text" required
                        class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-[var(--gold)] outline-none">
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">دسته‌بندی</label>
                    <div class="category-selector mt-1">
                        <input type="radio" name="category" id="cat-meeting"
                            value='{"name": "جلسه", "color": "#0A192F"}' checked><label for="cat-meeting"
                            style="--cat-color: #0A192F;">جلسه</label>
                        <input type="radio" name="category" id="cat-deadline"
                            value='{"name": "مهلت قانونی", "color": "#ef4444"}'><label for="cat-deadline"
                            style="--cat-color: #ef4444;">مهلت قانونی</label>
                        <input type="radio" name="category" id="cat-personal"
                            value='{"name": "شخصی", "color": "#22c55e"}'><label for="cat-personal"
                            style="--cat-color: #22c55e;">شخصی</label>
                        <input type="radio" name="category" id="cat-reminder"
                            value='{"name": "یادآوری", "color": "#c49827"}'><label for="cat-reminder"
                            style="--cat-color: #c49827;">یادآوری</label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-date" class="text-sm font-medium text-slate-700">تاریخ شروع</label>
                        <input id="event-date" type="date" required class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div class="flex items-center pt-6">
                        <input id="is-all-day" type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]">
                        <label for="is-all-day" class="mr-2 text-sm font-medium text-slate-700">رویداد تمام روز</label>
                    </div>
                </div>
                <div id="time-inputs" class="grid grid-cols-2 gap-4">
                    <div><label for="start-time" class="text-sm font-medium text-slate-700">ساعت شروع</label><input
                            id="start-time" type="time" required class="mt-1 w-full p-2 border rounded-md"></div>
                    <div><label for="end-time" class="text-sm font-medium text-slate-700">ساعت پایان</label><input
                            id="end-time" type="time" required class="mt-1 w-full p-2 border rounded-md"></div>
                </div>

                <div class="border-t pt-4">
                    <div class="flex items-center">
                        <input id="is-recurring" type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]">
                        <label for="is-recurring" class="mr-2 text-sm font-bold text-slate-800">رویداد
                            تکرارشونده</label>
                    </div>
                </div>
                <div id="recurring-options" class="hidden space-y-4 p-4 bg-slate-50 rounded-lg border">
                    <div>
                        <label class="text-sm font-medium text-slate-700 mb-2 block">تکرار در روزهای:</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2" id="weekday-selector">
                            <div class="flex items-center"><input type="checkbox" id="day-6" value="6"
                                    class="form-checkbox h-4 w-4"><label for="day-6" class="mr-2 text-sm">شنبه</label>
                            </div>
                            <div class="flex items-center"><input type="checkbox" id="day-0" value="0"
                                    class="form-checkbox h-4 w-4"><label for="day-0" class="mr-2 text-sm">یکشنبه</label>
                            </div>
                            <div class="flex items-center"><input type="checkbox" id="day-1" value="1"
                                    class="form-checkbox h-4 w-4"><label for="day-1" class="mr-2 text-sm">دوشنبه</label>
                            </div>
                            <div class="flex items-center"><input type="checkbox" id="day-2" value="2"
                                    class="form-checkbox h-4 w-4"><label for="day-2"
                                    class="mr-2 text-sm">سه‌شنبه</label></div>
                            <div class="flex items-center"><input type="checkbox" id="day-3" value="3"
                                    class="form-checkbox h-4 w-4"><label for="day-3"
                                    class="mr-2 text-sm">چهارشنبه</label></div>
                            <div class="flex items-center"><input type="checkbox" id="day-4" value="4"
                                    class="form-checkbox h-4 w-4"><label for="day-4"
                                    class="mr-2 text-sm">پنجشنبه</label></div>
                            <div class="flex items-center"><input type="checkbox" id="day-5" value="5"
                                    class="form-checkbox h-4 w-4"><label for="day-5" class="mr-2 text-sm">جمعه</label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="end-date" class="text-sm font-medium text-slate-700">تاریخ پایان تکرار</label>
                        <input id="end-date" type="date" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                </div>
                <div class="border-t pt-4">
                    <div class="flex items-center">
                        <input id="show-on-dashboard" type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]" checked>
                        <label for="show-on-dashboard" class="mr-2 text-sm font-medium text-slate-700">نمایش در ویجت
                            صفحه اصلی</label>
                    </div>
                </div>

                <div class="pt-4 flex justify-between items-center">
                    <button type="button" id="delete-event-btn"
                        class="px-4 py-2 rounded-md text-red-600 hover:bg-red-50 hidden">حذف رویداد</button>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-btn"
                            class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">انصراف</button>
                        <button type="submit" class="btn-gold">ذخیره</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalali-moment@3.3.11/dist/jalali-moment.browser.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- 1. SUPABASE CLIENT & ALL DOM ELEMENTS ---
            const SUPABASE_URL = 'https://evfgzegtplkhocfxcjpp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2Zmd6ZWd0cGxraG9jZnhjanBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDgyOTUsImV4cCI6MjA3NDcyNDI5NX0.eUDSqjhSK7Tk8rHfXV_tFTBzGbT3jBHJnLG70WVpV44';
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { storage: window.sessionStorage } });

            // (All other DOM element variables are defined here as before)
            const dayHeadersContainer = document.getElementById('day-headers');
            const allDayContainer = document.getElementById('all-day-events-container');
            const timeLabelsContainer = document.getElementById('time-labels');
            const timelineGrid = document.getElementById('timeline-grid');
            const timeIndicator = document.getElementById('current-time-indicator');
            const weekTitle = document.getElementById('week-title');
            const modal = document.getElementById('event-modal');
            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.getElementById('user-menu');
            // ... and so on for all elements

            // --- 2. STATE VARIABLES ---
            let currentUser = null;
            let currentMoment = moment();
            let allPublicEvents = []; // To store public events for the year
            let allPersonalEvents = []; // To store personal events for the week

            // --- 3. AUTHENTICATION & INITIALIZATION FLOW ---
            moment.locale('fa');

            _supabase.auth.onAuthStateChange(async (event, session) => {
                if (session && session.user) {
                    currentUser = session.user;
                    loginBtn.style.display = 'none';
                    userMenu.style.display = 'block';

                    const { data: profile } = await _supabase.from('profiles').select('has_premium_calendar').eq('id', currentUser.id).single();
                    if (!profile || !profile.has_premium_calendar) {
                        alert('دسترسی به این بخش نیازمند خرید تقویم پیشرفته است.');
                        window.location.href = 'calendar.html';
                        return;
                    }

                    setupWeekView(currentMoment);
                    updateCurrentTimeIndicator();
                    setInterval(updateCurrentTimeIndicator, 60000);

                } else {
                    window.location.href = 'login.html';
                }
            });

            // --- 4. EVENT LISTENERS (Profile, Navigation, Modal) ---
            // (This entire section is complete and correct as in the previous final version)

            // --- 5. CORE CALENDAR FUNCTIONS ---
            async function setupWeekView(date) {
                // (This function's implementation is complete and correct)
                dayHeadersContainer.innerHTML = '<div class="border-l"></div>';
                allDayContainer.innerHTML = '';
                timeLabelsContainer.innerHTML = '';
                timelineGrid.innerHTML = '';

                const startOfWeek = date.clone().startOf('jWeek');
                weekTitle.textContent = `هفته ${startOfWeek.format('jD jMMMM')}`;

                for (let i = 0; i < 7; i++) {
                    // ... (Code to build headers and columns)
                }

                for (let i = 8; i <= 23; i++) {
                    timeLabelsContainer.innerHTML += `<div class="time-label h-[60px]">${i}:00</div>`;
                }

                // The main data loading function is called here
                await loadAndRenderAllEvents(date);
            }

            // --- NEW & IMPROVED: Data Loading Function ---
            async function loadAndRenderAllEvents(date) {
                // Clear previous events from view
                document.querySelectorAll('.event-block, .all-day-event-block').forEach(el => el.remove());

                const startOfWeek = date.clone().startOf('jWeek');
                const endOfWeek = date.clone().endOf('jWeek');
                const year = date.jYear();

                // Step 1: Fetch PUBLIC events from Python API
                try {
                    const response = await fetch(`https://alireza0naderiii.pythonanywhere.com/api/events/${year}`);
                    if (response.ok) {
                        allPublicEvents = await response.json();
                        // Filter for the current week and render them
                        const weekPublicEvents = allPublicEvents.filter(e => moment(e.date, 'YYYY-MM-DD').isBetween(startOfWeek, endOfWeek, 'day', '[]'));
                        weekPublicEvents.forEach(renderPublicEvent);
                    }
                } catch (error) {
                    console.error("Failed to fetch public events:", error);
                }

                // Step 2: Fetch PERSONAL events from Supabase
                const { data, error } = await _supabase.from('user_personal_events').select('*').eq('user_id', currentUser.id).gte('event_date', startOfWeek.format('YYYY-MM-DD')).lte('event_date', endOfWeek.format('YYYY-MM-DD'));
                if (error) return console.error("Error fetching personal events:", error);

                allPersonalEvents = data;
                allPersonalEvents.forEach(renderPersonalEvent);
            }

            // --- NEW: Function to render PUBLIC events ---
            function renderPublicEvent(event) {
                const eventDateStr = event.date; // Note: 'date' not 'event_date'
                const dayColumn = document.getElementById(`all-day-col-${eventDateStr}`);
                if (!dayColumn) return;

                const eventElement = document.createElement('div');
                eventElement.className = 'all-day-event-block';
                eventElement.style.backgroundColor = 'var(--navy)'; // Default color for public events
                eventElement.textContent = event.title;
                dayColumn.appendChild(eventElement);
            }

            // --- RENAMED: Function to render PERSONAL events ---
            function renderPersonalEvent(event) {
                const eventDateStr = event.event_date;
                const eventElement = document.createElement('div');
                eventElement.textContent = event.title;
                eventElement.dataset.eventId = event.id;
                eventElement.style.backgroundColor = event.color;

                if (event.is_all_day) {
                    eventElement.className = 'all-day-event-block';
                    document.getElementById(`all-day-col-${eventDateStr}`).appendChild(eventElement);
                } else {
                    const dayColumn = document.getElementById(`day-col-${eventDateStr}`);
                    if (!dayColumn || !event.start_time || !event.end_time) return;
                    const startMinutes = timeToMinutes(event.start_time);
                    const endMinutes = timeToMinutes(event.end_time);
                    if (startMinutes >= endMinutes) return;
                    const topOffset = ((startMinutes - (8 * 60)) / 60) * 60;
                    const height = ((endMinutes - startMinutes) / 60) * 60;
                    eventElement.className = 'event-block';
                    eventElement.style.cssText += `top: ${topOffset}px; height: ${height}px;`;
                    eventElement.innerHTML = `<p class="font-bold">${event.title}</p><p class="text-xs opacity-80">${event.start_time} - ${event.end_time}</p>`;
                    dayColumn.appendChild(eventElement);
                }
                eventElement.addEventListener('click', () => openEditModal(event));
            }

            // (All other functions like timeToMinutes, openEditModal, form submission logic, etc., are here in their complete form)
        });
    </script>
</body>

</html>