<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقویم هفتگی - آیدا شیرازی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Vazirmatn:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --navy: #0A192F;
            --slate-800: #1e293b;
            --slate-600: #475569;
            --slate-100: #f1f5f9;
            --gold: #c49827;
            --light-gold: #FBEFCE;
            --font-display: 'Lalezar', cursive;
            --font-body: 'Vazirmatn', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--slate-100);
        }

        h1,
        h2,
        .font-display {
            font-family: var(--font-display);
        }

        .main-header {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-link {
            transition: color 0.3s ease;
            color: var(--slate-800);
            font-weight: 500;
        }

        .nav-link:hover {
            color: var(--navy);
        }

        .btn-gold {
            background-color: var(--gold);
            color: var(--navy);
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            transition: all 0.2s;
        }

        .btn-gold:hover:not(:disabled) {
            background-color: #b98d1e;
            transform: translateY(-2px);
        }

        /* New styles inspired by calendar.html */
        .day-header-cell {
            text-align: center;
            padding: 0.75rem 0.25rem;
            font-weight: 600;
            color: var(--slate-600);
        }

        .day-header-cell.today .day-number-weekly {
            background-color: var(--gold);
            color: white;
        }

        .day-number-weekly {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: 700;
            margin-top: 4px;
        }

        .time-label {
            text-align: center;
            font-size: 0.75rem;
            color: var(--slate-500);
            position: relative;
            top: -8px;
        }

        .day-column {
            border-left: 1px solid #e2e8f0;
            position: relative;
        }

        .day-column:last-child {
            border-left: none;
        }

        .hour-line {
            height: 60px;
            border-top: 1px dotted #d1d5db;
        }

        .event-block,
        .all-day-event-block {
            color: white;
            border-radius: 6px;
            padding: 4px 8px;
            overflow: hidden;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-right: 3px solid rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            cursor: pointer;
        }

        .event-block:hover,
        .all-day-event-block:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .event-block {
            position: absolute;
            right: 4px;
            left: 4px;
        }

        .all-day-event-block {
            margin-bottom: 4px;
            font-weight: 500;
        }

        #current-time-indicator {
            position: absolute;
            left: 0;
            right: 80px;
            height: 2px;
            background-color: #ef4444;
            z-index: 20;
            pointer-events: none;
            transition: top 0.5s;
        }

        #current-time-indicator::before {
            content: '';
            position: absolute;
            right: -6px;
            top: -5px;
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
        }

        #event-modal {
            transition: opacity 0.3s ease;
        }

        .category-selector input[type="radio"] {
            display: none;
        }

        .category-selector label {
            padding: 6px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-selector input[type="radio"]:checked+label {
            background-color: var(--cat-color);
            color: white;
            border-color: var(--cat-color);
        }
    </style>
</head>

<body class="bg-slate-100">

    <header class="main-header sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://i.postimg.cc/j519gM1p/dd6fd5aa-9d3e-4a23-85e5-5ee9a534197e.jpg" alt="لوگو"
                    class="w-10 h-10 rounded-full">
                <a href="index.html" class="text-xl font-bold font-display" style="color: var(--navy);">آیدا شیرازی</a>
            </div>
            <div class="hidden md:flex items-center space-x-10 space-x-reverse">
                <a href="index.html#roadmap" class="nav-link">نقشه راه</a>
                <a href="documents.html" class="nav-link">اسناد حسابداری</a>
                <a href="calendar.html" class="nav-link">تقویم هوشمند</a>
                <a href="calculator.html" class="nav-link">ماشین حساب</a>
                <a href="index.html#updates" class="nav-link">آخرین تغییرات</a>
                <a href="index.html#about" class="nav-link">درباره من</a>
            </div>
            <div id="profile-section" class="relative">
                <a href="login.html" id="login-btn" class="btn-gold flex items-center justify-center gap-2 px-4 py-2">
                    <i class="fa-solid fa-right-to-bracket"></i>
                    <span>ورود / ثبت‌نام</span>
                </a>
                <div id="user-menu" class="hidden">
                    <button id="profile-toggle-btn"
                        class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--gold)]">
                        <i class="fa-solid fa-user text-slate-600"></i>
                    </button>
                    <div id="dropdown-menu"
                        class="hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-50">
                        <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">تنظیمات
                            پروفایل</a>
                        <a href="#" id="logout-btn"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">خروج</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-6 mt-8">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <h1 id="week-title" class="text-3xl md:text-4xl font-display text-[var(--navy)]"></h1>
                <div class="flex items-center gap-2">
                    <button id="prev-week-btn"
                        class="bg-white rounded-full w-9 h-9 shadow-sm hover:bg-slate-50 transition"><i
                            class="fa fa-chevron-left"></i></button>
                    <button id="next-week-btn"
                        class="bg-white rounded-full w-9 h-9 shadow-sm hover:bg-slate-50 transition"><i
                            class="fa fa-chevron-right"></i></button>
                    <button id="today-btn"
                        class="text-sm font-semibold bg-white rounded-lg px-3 py-1.5 shadow-sm hover:bg-slate-50 transition">امروز</button>
                </div>
            </div>
            <button id="add-event-btn" class="btn-gold"><i class="fa-solid fa-plus ml-2"></i><span>افزودن
                    رویداد</span></button>
        </div>

        <div id="weekly-container" class="bg-white rounded-xl shadow-xl overflow-hidden">
            <div id="day-headers" class="grid grid-cols-[80px_repeat(7,1fr)] bg-slate-50 z-10 border-b"></div>
            <div id="all-day-section" class="grid grid-cols-[80px_1fr] border-b">
                <div class="text-center font-semibold text-xs py-2 border-l text-slate-500">تمام روز</div>
                <div id="all-day-events-container" class="grid grid-cols-7 relative"></div>
            </div>
            <div class="relative overflow-y-auto" style="height: calc(16 * 60px);">
                <div id="weekly-grid" class="grid grid-cols-[80px_1fr]">
                    <div id="time-labels"></div>
                    <div id="timeline-grid" class="grid grid-cols-7"></div>
                </div>
                <div id="current-time-indicator" class="hidden"></div>
            </div>
        </div>
    </main>

    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-display text-[var(--navy)] mb-6">ثبت رویداد جدید</h2>
            <form id="event-form" class="space-y-4">
                <input type="hidden" id="event-id">
                <div>
                    <label for="event-title" class="text-sm font-medium text-slate-700">عنوان رویداد</label>
                    <input id="event-title" type="text" required
                        class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-[var(--gold)] outline-none">
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">دسته‌بندی</label>
                    <div class="category-selector mt-1">
                        <input type="radio" name="category" id="cat-meeting"
                            value='{"name": "جلسه", "color": "#0A192F"}' checked><label for="cat-meeting"
                            style="--cat-color: #0A192F;">جلسه</label>
                        <input type="radio" name="category" id="cat-deadline"
                            value='{"name": "مهلت قانونی", "color": "#ef4444"}'><label for="cat-deadline"
                            style="--cat-color: #ef4444;">مهلت قانونی</label>
                        <input type="radio" name="category" id="cat-personal"
                            value='{"name": "شخصی", "color": "#22c55e"}'><label for="cat-personal"
                            style="--cat-color: #22c55e;">شخصی</label>
                        <input type="radio" name="category" id="cat-reminder"
                            value='{"name": "یادآوری", "color": "#c49827"}'><label for="cat-reminder"
                            style="--cat-color: #c49827;">یادآوری</label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-date" class="text-sm font-medium text-slate-700">تاریخ شروع</label>
                        <input id="event-date" type="date" required class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div class="flex items-center pt-6">
                        <input id="is-all-day" type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]">
                        <label for="is-all-day" class="mr-2 text-sm font-medium text-slate-700">رویداد تمام روز</label>
                    </div>
                </div>
                <div id="time-inputs" class="grid grid-cols-2 gap-4">
                    <div><label for="start-time" class="text-sm font-medium text-slate-700">ساعت شروع</label><input
                            id="start-time" type="time" required class="mt-1 w-full p-2 border rounded-md"></div>
                    <div><label for="end-time" class="text-sm font-medium text-slate-700">ساعت پایان</label><input
                            id="end-time" type="time" required class="mt-1 w-full p-2 border rounded-md"></div>
                </div>
                <div class="border-t pt-4">
                    <div class="flex items-center">
                        <input id="is-recurring" type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]">
                        <label for="is-recurring" class="mr-2 text-sm font-bold text-slate-800">رویداد
                            تکرارشونده</label>
                    </div>
                </div>
                <div id="recurring-options" class="hidden space-y-4 p-4 bg-slate-50 rounded-lg border">
                    <div>
                        <label class="text-sm font-medium text-slate-700 mb-2 block">تکرار در روزهای:</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2" id="weekday-selector">
                            <div class="flex items-center"><input type="checkbox" id="day-6" value="6"
                                    class="form-checkbox h-4 w-4"><label for="day-6" class="mr-2 text-sm">شنبه</label>
                            </div>
                            <div class="flex items-center"><input type="checkbox" id="day-0" value="0"
                                    class="form-checkbox h-4 w-4"><label for="day-0" class="mr-2 text-sm">یکشنبه</label>
                            </div>
                            <div class="flex items-center"><input type="checkbox" id="day-1" value="1"
                                    class="form-checkbox h-4 w-4"><label for="day-1" class="mr-2 text-sm">دوشنبه</label>
                            </div>
                            <div class="flex items-center"><input type="checkbox" id="day-2" value="2"
                                    class="form-checkbox h-4 w-4"><label for="day-2"
                                    class="mr-2 text-sm">سه‌شنبه</label></div>
                            <div class="flex items-center"><input type="checkbox" id="day-3" value="3"
                                    class="form-checkbox h-4 w-4"><label for="day-3"
                                    class="mr-2 text-sm">چهارشنبه</label></div>
                            <div class="flex items-center"><input type="checkbox" id="day-4" value="4"
                                    class="form-checkbox h-4 w-4"><label for="day-4"
                                    class="mr-2 text-sm">پنجشنبه</label></div>
                            <div class="flex items-center"><input type="checkbox" id="day-5" value="5"
                                    class="form-checkbox h-4 w-4"><label for="day-5" class="mr-2 text-sm">جمعه</label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="end-date" class="text-sm font-medium text-slate-700">تاریخ پایان تکرار</label>
                        <input id="end-date" type="date" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                </div>
                <div class="border-t pt-4">
                    <div class="flex items-center">
                        <input id="show-on-dashboard" type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-[var(--gold)] focus:ring-[var(--gold)]" checked>
                        <label for="show-on-dashboard" class="mr-2 text-sm font-medium text-slate-700">نمایش در ویجت
                            صفحه اصلی</label>
                    </div>
                </div>
                <div class="pt-4 flex justify-between items-center">
                    <button type="button" id="delete-event-btn"
                        class="px-4 py-2 rounded-md text-red-600 hover:bg-red-50 hidden">حذف رویداد</button>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-btn"
                            class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">انصراف</button>
                        <button type="submit" class="btn-gold">ذخیره</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalali-moment@3.3.11/dist/jalali-moment.browser.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const SUPABASE_URL = 'https://evfgzegtplkhocfxcjpp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2Zmd6ZWd0cGxraG9jZnhjanBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDgyOTUsImV4cCI6MjA3NDcyNDI5NX0.eUDSqjhSK7Tk8rHfXV_tFTBzGbT3jBHJnLG70WVpV44';
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { storage: window.sessionStorage } });

            const dayHeadersContainer = document.getElementById('day-headers');
            const allDayContainer = document.getElementById('all-day-events-container');
            const timeLabelsContainer = document.getElementById('time-labels');
            const timelineGrid = document.getElementById('timeline-grid');
            const timeIndicator = document.getElementById('current-time-indicator');
            const weekTitle = document.getElementById('week-title');
            const modal = document.getElementById('event-modal');
            const modalTitle = document.getElementById('modal-title');
            const addEventBtn = document.getElementById('add-event-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const eventForm = document.getElementById('event-form');
            const isAllDayCheckbox = document.getElementById('is-all-day');
            const timeInputs = document.getElementById('time-inputs');
            const deleteEventBtn = document.getElementById('delete-event-btn');
            const isRecurringCheckbox = document.getElementById('is-recurring');
            const recurringOptions = document.getElementById('recurring-options');
            const weekdaySelector = document.getElementById('weekday-selector');
            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.getElementById('user-menu');
            const profileToggleBtn = document.getElementById('profile-toggle-btn');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const logoutBtn = document.getElementById('logout-btn');

            let currentUser = null;
            let currentMoment = moment();
            let allPublicEvents = [];
            let allPersonalEvents = [];

            moment.locale('fa');

            _supabase.auth.onAuthStateChange(async (event, session) => {
                if (session && session.user) {
                    currentUser = session.user;
                    loginBtn.style.display = 'none';
                    userMenu.style.display = 'block';

                    const { data: profile } = await _supabase.from('profiles').select('has_premium_calendar').eq('id', currentUser.id).single();
                    if (!profile || !profile.has_premium_calendar) {
                        alert('دسترسی به این بخش نیازمند خرید تقویم پیشرفته است.');
                        window.location.href = 'calendar.html';
                        return;
                    }

                    setupWeekView(currentMoment);
                    updateCurrentTimeIndicator();
                    setInterval(updateCurrentTimeIndicator, 60000);
                } else {
                    window.location.href = 'login.html';
                }
            });

            if (profileToggleBtn) profileToggleBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('hidden'); });
            if (logoutBtn) logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await _supabase.auth.signOut(); sessionStorage.clear(); window.location.replace('index.html'); });
            window.addEventListener('click', () => { if (dropdownMenu && !dropdownMenu.classList.contains('hidden')) dropdownMenu.classList.add('hidden'); });

            document.getElementById('prev-week-btn').addEventListener('click', () => { currentMoment.subtract(1, 'week'); setupWeekView(currentMoment); });
            document.getElementById('next-week-btn').addEventListener('click', () => { currentMoment.add(1, 'week'); setupWeekView(currentMoment); });
            document.getElementById('today-btn').addEventListener('click', () => { currentMoment = moment(); setupWeekView(currentMoment); });

            addEventBtn.addEventListener('click', () => {
                modalTitle.textContent = 'ثبت رویداد جدید';
                eventForm.reset();
                document.getElementById('show-on-dashboard').checked = true;
                isRecurringCheckbox.disabled = false;
                timeInputs.style.display = 'grid';
                eventForm['start-time'].required = true;
                eventForm['end-time'].required = true;
                recurringOptions.classList.add('hidden');
                document.getElementById('end-date').required = false;
                deleteEventBtn.classList.add('hidden');
                modal.classList.remove('hidden');
            });

            cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));

            isAllDayCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                timeInputs.style.display = isChecked ? 'none' : 'grid';
                eventForm['start-time'].required = !isChecked;
                eventForm['end-time'].required = !isChecked;
            });

            isRecurringCheckbox.addEventListener('change', (e) => {
                recurringOptions.classList.toggle('hidden', !e.target.checked);
                document.getElementById('end-date').required = e.target.checked;
            });

            deleteEventBtn.addEventListener('click', async () => {
                const eventId = eventForm['event-id'].value;
                if (!eventId || !confirm('آیا از حذف این رویداد مطمئن هستید؟')) return;
                const { error } = await _supabase.from('user_personal_events').delete().eq('id', eventId);
                if (error) {
                    alert("خطا در حذف رویداد: " + error.message);
                } else {
                    modal.classList.add('hidden');
                    setupWeekView(currentMoment);
                }
            });

            eventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const eventId = e.target['event-id'].value;
                const isRecurring = isRecurringCheckbox.checked;

                if (isRecurring && !eventId) {
                    const startDate = moment(e.target['event-date'].value, 'YYYY-MM-DD');
                    const endDate = moment(e.target['end-date'].value, 'YYYY-MM-DD');
                    const selectedWeekdays = Array.from(weekdaySelector.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));

                    if (selectedWeekdays.length === 0) return alert('لطفاً حداقل یک روز از هفته را برای تکرار انتخاب کنید.');
                    if (!endDate.isAfter(startDate)) return alert('تاریخ پایان تکرار باید بعد از تاریخ شروع باشد.');

                    const eventsToInsert = [];
                    const categoryData = JSON.parse(e.target['category'].value);
                    let currentDay = startDate.clone();
                    while (currentDay.isSameOrBefore(endDate)) {
                        if (selectedWeekdays.includes(currentDay.day())) {
                            eventsToInsert.push({
                                title: e.target['event-title'].value,
                                event_date: currentDay.format('YYYY-MM-DD'),
                                is_all_day: e.target['is-all-day'].checked,
                                category: categoryData.name,
                                color: categoryData.color,
                                start_time: e.target['is-all-day'].checked ? null : e.target['start-time'].value,
                                end_time: e.target['is-all-day'].checked ? null : e.target['end-time'].value,
                                show_on_dashboard: document.getElementById('show-on-dashboard').checked,
                                user_id: currentUser.id,
                            });
                        }
                        currentDay.add(1, 'day');
                    }

                    if (eventsToInsert.length === 0) return alert('هیچ روزی مطابق با روزهای انتخابی شما در بازه زمانی مشخص شده یافت نشد.');

                    const { error } = await _supabase.from('user_personal_events').insert(eventsToInsert);
                    if (error) {
                        alert("خطا در ذخیره رویدادهای تکرارشونده: " + error.message);
                    } else {
                        modal.classList.add('hidden');
                        setupWeekView(currentMoment);
                    }
                } else {
                    const categoryData = JSON.parse(e.target['category'].value);
                    const eventData = {
                        title: e.target['event-title'].value,
                        event_date: e.target['event-date'].value,
                        is_all_day: e.target['is-all-day'].checked,
                        category: categoryData.name,
                        color: categoryData.color,
                        start_time: e.target['is-all-day'].checked ? null : e.target['start-time'].value,
                        end_time: e.target['is-all-day'].checked ? null : e.target['end-time'].value,
                        show_on_dashboard: document.getElementById('show-on-dashboard').checked,
                        user_id: currentUser.id,
                    };

                    let error;
                    if (eventId) {
                        ({ error } = await _supabase.from('user_personal_events').update(eventData).eq('id', eventId));
                    } else {
                        ({ error } = await _supabase.from('user_personal_events').insert([eventData]));
                    }

                    if (error) {
                        alert("خطا در ذخیره رویداد: " + error.message);
                    } else {
                        modal.classList.add('hidden');
                        setupWeekView(currentMoment);
                    }
                }
            });

            async function setupWeekView(date) {
                dayHeadersContainer.innerHTML = '<div class="border-l"></div>';
                allDayContainer.innerHTML = '';
                timeLabelsContainer.innerHTML = '';
                timelineGrid.innerHTML = '';
                const startOfWeek = date.clone().startOf('jWeek');
                weekTitle.textContent = `هفته ${startOfWeek.format('jD jMMMM')}`;

                for (let i = 0; i < 7; i++) {
                    const dayMoment = startOfWeek.clone().add(i, 'days');
                    const isToday = dayMoment.isSame(moment(), 'day');

                    dayHeadersContainer.innerHTML += `<div class="day-header-cell ${isToday ? 'today' : ''}"><span class="day-name">${dayMoment.format('dddd')}</span><div class="day-number-weekly">${dayMoment.format('jD')}</div></div>`;
                    allDayContainer.innerHTML += `<div id="all-day-col-${dayMoment.format('YYYY-MM-DD')}" class="border-l p-1 space-y-1"></div>`;
                    timelineGrid.innerHTML += `<div id="day-col-${dayMoment.format('YYYY-MM-DD')}" class="day-column">${Array(16).fill('<div class="hour-line"></div>').join('')}</div>`;
                }

                for (let i = 8; i <= 23; i++) {
                    timeLabelsContainer.innerHTML += `<div class="time-label h-[60px]">${i}:00</div>`;
                }

                await loadAndRenderAllEvents(date);
            }

            async function loadAndRenderAllEvents(date) {
                const startOfWeek = date.clone().startOf('jWeek');
                const endOfWeek = date.clone().endOf('jWeek');
                const year = date.jYear();

                try {
                    const response = await fetch(`https://alireza0naderiii.pythonanywhere.com/api/events/${year}`);
                    if (response.ok) {
                        allPublicEvents = await response.json();
                        const weekPublicEvents = allPublicEvents.filter(e => moment(e.date, 'YYYY-MM-DD').isBetween(startOfWeek, endOfWeek, 'day', '[]'));
                        weekPublicEvents.forEach(renderPublicEvent);
                    }
                } catch (error) {
                    console.error("Failed to fetch public events:", error);
                }

                const { data, error } = await _supabase.from('user_personal_events').select('*').eq('user_id', currentUser.id).gte('event_date', startOfWeek.format('YYYY-MM-DD')).lte('event_date', endOfWeek.format('YYYY-MM-DD'));
                if (error) return console.error("Error fetching personal events:", error);

                allPersonalEvents = data;
                allPersonalEvents.forEach(renderPersonalEvent);
            }

            function renderPublicEvent(event) {
                const eventDateStr = event.date;
                const dayColumn = document.getElementById(`all-day-col-${eventDateStr}`);
                if (!dayColumn) return;
                const eventElement = document.createElement('div');
                eventElement.className = 'all-day-event-block';
                eventElement.style.backgroundColor = 'var(--navy)';
                eventElement.textContent = event.title;
                dayColumn.appendChild(eventElement);
            }

            function renderPersonalEvent(event) {
                const eventDateStr = event.event_date;
                const eventElement = document.createElement('div');
                eventElement.dataset.eventId = event.id;
                eventElement.style.backgroundColor = event.color;

                if (event.is_all_day) {
                    eventElement.className = 'all-day-event-block';
                    eventElement.textContent = event.title;
                    document.getElementById(`all-day-col-${eventDateStr}`).appendChild(eventElement);
                } else {
                    const dayColumn = document.getElementById(`day-col-${eventDateStr}`);
                    if (!dayColumn || !event.start_time || !event.end_time) return;
                    const startMinutes = timeToMinutes(event.start_time);
                    const endMinutes = timeToMinutes(event.end_time);
                    if (startMinutes >= endMinutes) return;
                    const topOffset = ((startMinutes - (8 * 60)) / 60) * 60;
                    const height = ((endMinutes - startMinutes) / 60) * 60;
                    eventElement.className = 'event-block';
                    eventElement.style.cssText += `top: ${topOffset}px; height: ${height}px;`;
                    eventElement.innerHTML = `<p class="font-bold">${event.title}</p><p class="text-xs opacity-80">${event.start_time} - ${event.end_time}</p>`;
                    dayColumn.appendChild(eventElement);
                }
                eventElement.addEventListener('click', () => openEditModal(event));
            }

            function openEditModal(event) {
                modalTitle.textContent = 'ویرایش رویداد';
                eventForm.reset();
                isRecurringCheckbox.checked = false;
                isRecurringCheckbox.disabled = true;
                recurringOptions.classList.add('hidden');
                eventForm['event-id'].value = event.id;
                eventForm['event-title'].value = event.title;
                eventForm['event-date'].value = event.event_date;
                document.getElementById('show-on-dashboard').checked = event.show_on_dashboard;
                const categoryRadio = document.querySelector(`input[name="category"][value*='"color": "${event.color}"']`);
                if (categoryRadio) categoryRadio.checked = true;

                isAllDayCheckbox.checked = event.is_all_day;
                if (event.is_all_day) {
                    timeInputs.style.display = 'none';
                    eventForm['start-time'].required = false;
                    eventForm['end-time'].required = false;
                } else {
                    timeInputs.style.display = 'grid';
                    eventForm['start-time'].required = true;
                    eventForm['end-time'].required = true;
                    eventForm['start-time'].value = event.start_time;
                    eventForm['end-time'].value = event.end_time;
                }
                deleteEventBtn.classList.remove('hidden');
                modal.classList.remove('hidden');
            }

            function timeToMinutes(timeStr) {
                if (!timeStr) return 0;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            function updateCurrentTimeIndicator() {
                const now = moment();
                if (!now.isSame(currentMoment, 'week')) {
                    timeIndicator.classList.add('hidden');
                    return;
                }
                const dayDateStr = now.format('YYYY-MM-DD');
                const dayColumn = document.getElementById(`day-col-${dayDateStr}`);
                if (!dayColumn) {
                    timeIndicator.classList.add('hidden');
                    return;
                }
                const startOfDay = now.clone().hour(8).minute(0).second(0);
                if (now.hour() < 8 || now.hour() >= 24) {
                    timeIndicator.classList.add('hidden');
                    return;
                }
                const minutesSince8AM = now.diff(startOfDay, 'minutes');
                const topPosition = (minutesSince8AM / 60) * 60;
                timeIndicator.style.top = `${topPosition}px`;
                timeIndicator.style.left = `${dayColumn.offsetLeft + 80}px`;
                timeIndicator.style.width = `${dayColumn.offsetWidth}px`;
                timeIndicator.style.right = 'auto';
                timeIndicator.classList.remove('hidden');
            }
        });
    </script>
</body>

</html>