<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود و ثبت‌نام - آیدا شیرازی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Vazirmatn:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --navy: #0A192F;
            --slate-800: #1e293b;
            --slate-600: #475569;
            --slate-100: #f1f5f9;
            --gold: #c49827;
            --light-gold: #FBEFCE;
            --font-display: 'Lalezar', cursive;
            --font-body: 'Vazirmatn', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--slate-100);
        }

        h1,
        h2,
        .font-display {
            font-family: var(--font-display);
        }

        .form-container {
            display: block;
        }

        .form-container.hidden {
            display: none;
        }

        #notification {
            transition: opacity 0.3s ease-in-out;
        }

        #notification.hidden {
            opacity: 0;
            display: none;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-lg">

        <div id="notification" class="hidden p-4 mb-4 text-sm rounded-lg flex justify-between items-center"
            role="alert">
            <span id="notification-message"></span>
            <button id="notification-close" class="ml-4 font-bold">&times;</button>
        </div>

        <div id="login-form" class="form-container">
            <h1 class="text-3xl font-display text-center text-[var(--navy)]">ورود به حساب</h1>
            <form id="login-form-element" class="mt-8 space-y-6">
                <div>
                    <label for="login-identifier" class="text-sm font-medium text-slate-700">ایمیل یا نام کاربری</label>
                    <input id="login-identifier" name="identifier" type="text" required autocomplete="username"
                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-slate-700">رمز عبور</label>
                    <input id="login-password" name="password" type="password" required autocomplete="current-password"
                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <button type="submit"
                    class="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-sm font-semibold text-[var(--navy)] bg-[var(--gold)] hover:bg-[#b98d1e]">ورود</button>
            </form>
            <div class="mt-4 text-center text-sm space-y-2">
                <p>حساب کاربری ندارید؟ <a href="#" id="show-register"
                        class="font-medium text-[var(--gold)] hover:underline">ثبت‌نام کنید</a></p>
                <div>
                    <a href="#" id="show-forgot-password" class="font-medium text-[var(--gold)] hover:underline">فراموشی
                        رمز عبور</a>
                    <span class="mx-2 text-slate-400">|</span>
                    <a href="#" id="show-forgot-username" class="font-medium text-[var(--gold)] hover:underline">فراموشی
                        نام کاربری</a>
                </div>
            </div>
        </div>

        <div id="register-form" class="form-container hidden">
            <h1 class="text-3xl font-display text-center text-[var(--navy)]">ایجاد حساب جدید</h1>
            <form id="register-form-element" class="mt-8 space-y-6">
                <div>
                    <label for="register-username" class="text-sm font-medium text-slate-700">نام کاربری</label>
                    <input id="register-username" name="username" type="text" required
                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="register-email" class="text-sm font-medium text-slate-700">ایمیل</label>
                    <input id="register-email" name="email" type="email" required autocomplete="email"
                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="register-password" class="text-sm font-medium text-slate-700">رمز عبور</label>
                    <input id="register-password" name="password" type="password" required autocomplete="new-password"
                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                    <p class="mt-2 text-xs text-slate-500">حداقل ۸ کاراکتر، شامل حروف بزرگ و کوچک، عدد و علائم خاص.</p>
                </div>
                <button type="submit"
                    class="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-sm font-semibold text-[var(--navy)] bg-[var(--gold)] hover:bg-[#b98d1e]">ثبت‌نام</button>
            </form>
            <p class="mt-4 text-center text-sm">قبلاً ثبت‌نام کرده‌اید؟ <a href="#" id="show-login-from-register"
                    class="font-medium text-[var(--gold)] hover:underline">وارد شوید</a></p>
        </div>

        <div id="forgot-password-form" class="form-container hidden">
            <h1 class="text-3xl font-display text-center text-[var(--navy)]">بازیابی رمز عبور</h1>
            <p class="text-center text-slate-500 mt-2">ایمیل خود را وارد کنید تا لینک بازیابی ارسال شود.</p>
            <form id="forgot-password-form-element" class="mt-8 space-y-6">
                <div>
                    <label for="forgot-password-email" class="text-sm font-medium text-slate-700">ایمیل</label>
                    <input id="forgot-password-email" name="email" type="email" required
                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <button type="submit"
                    class="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-sm font-semibold text-[var(--navy)] bg-[var(--gold)] hover:bg-[#b98d1e]">ارسال
                    لینک</button>
            </form>
            <p class="mt-4 text-center text-sm"><a href="#"
                    class="show-login font-medium text-[var(--gold)] hover:underline">بازگشت به صفحه ورود</a></p>
        </div>

        <div id="forgot-username-form" class="form-container hidden">
            <h1 class="text-3xl font-display text-center text-[var(--navy)]">بازیابی نام کاربری</h1>
            <p class="text-center text-slate-500 mt-2">ایمیل خود را وارد کنید تا نام کاربری شما را پیدا کنیم.</p>
            <form id="forgot-username-form-element" class="mt-8 space-y-6">
                <div>
                    <label for="forgot-username-email" class="text-sm font-medium text-slate-700">ایمیل</label>
                    <input id="forgot-username-email" name="email" type="email" required
                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                </div>
                <button type="submit"
                    class="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-sm font-semibold text-[var(--navy)] bg-[var(--gold)] hover:bg-[#b98d1e]">پیدا
                    کردن نام کاربری</button>
            </form>
            <p class="mt-4 text-center text-sm"><a href="#"
                    class="show-login font-medium text-[var(--gold)] hover:underline">بازگشت به صفحه ورود</a></p>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://evfgzegtplkhocfxcjpp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2Zmd6ZWd0cGxraG9jZnhjanBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDgyOTUsImV4cCI6MjA3NDcyNDI5NX0.eUDSqjhSK7Tk8rHfXV_tFTBzGbT3jBHJnLG70WVpV44';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { storage: window.sessionStorage } });

        const allForms = document.querySelectorAll('.form-container');
        const loginFormDiv = document.getElementById('login-form');
        const registerFormDiv = document.getElementById('register-form');
        const forgotPasswordFormDiv = document.getElementById('forgot-password-form');
        const forgotUsernameFormDiv = document.getElementById('forgot-username-form');

        const loginForm = document.getElementById('login-form-element');
        const registerForm = document.getElementById('register-form-element');
        const forgotPasswordForm = document.getElementById('forgot-password-form-element');
        const forgotUsernameForm = document.getElementById('forgot-username-form-element');

        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const notificationClose = document.getElementById('notification-close');

        function showNotification(message, type = 'error') {
            notificationMessage.textContent = message;
            if (type === 'success') {
                notification.classList.remove('bg-red-100', 'text-red-700');
                notification.classList.add('bg-green-100', 'text-green-700');
            } else {
                notification.classList.remove('bg-green-100', 'text-green-700');
                notification.classList.add('bg-red-100', 'text-red-700');
            }
            notification.classList.remove('hidden');
        }

        notificationClose.addEventListener('click', () => {
            notification.classList.add('hidden');
        });

        function showForm(formToShow) {
            notification.classList.add('hidden');
            allForms.forEach(form => form.classList.add('hidden'));
            formToShow.classList.remove('hidden');
        }

        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); showForm(registerFormDiv); });
        document.getElementById('show-login-from-register').addEventListener('click', (e) => { e.preventDefault(); showForm(loginFormDiv); });
        document.getElementById('show-forgot-password').addEventListener('click', (e) => { e.preventDefault(); showForm(forgotPasswordFormDiv); });
        document.getElementById('show-forgot-username').addEventListener('click', (e) => { e.preventDefault(); showForm(forgotUsernameFormDiv); });
        document.querySelectorAll('.show-login').forEach(el => el.addEventListener('click', (e) => { e.preventDefault(); showForm(loginFormDiv); }));

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = e.target.identifier.value;
            const password = e.target.password.value;
            let email = identifier;

            if (!identifier.includes('@')) {
                const { data, error } = await _supabase.rpc('get_email_by_username', { user_name: identifier });
                if (data) {
                    email = data;
                }
            }

            const { error: signInError } = await _supabase.auth.signInWithPassword({ email, password });

            if (signInError) {
                showNotification('اطلاعات ورود نامعتبر است. لطفاً دوباره تلاش کنید.');
            } else {
                window.location.href = 'index.html';
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = e.target.password.value;
            if (password.length < 8 || !/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/\d/.test(password) || !/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                showNotification('رمز عبور باید حداقل ۸ کاراکتر و شامل حرف بزرگ، حرف کوچک، عدد و علائم خاص باشد.');
                return;
            }
            const { error } = await _supabase.auth.signUp({
                email: e.target.email.value,
                password: password,
                options: { data: { username: e.target.username.value } }
            });
            if (error) {
                showNotification('خطا در ثبت‌نام: ' + error.message);
            } else {
                showNotification('ایمیل تایید برای شما ارسال شد. لطفاً صندوق ورودی خود را چک کنید.', 'success');
                e.target.reset(); // Clear form on success
            }
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const { error } = await _supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/index.html' });
            if (error) {
                showNotification('خطا: ' + error.message);
            } else {
                showNotification('اگر این ایمیل در سیستم ما موجود باشد، لینک بازیابی برایتان ارسال خواهد شد.', 'success');
                e.target.reset(); // Clear form on success
            }
        });

        forgotUsernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = e.target.email.value;
            const { data, error } = await _supabase.rpc('get_username_by_email', { user_email: email });
            if (error || !data) {
                showNotification('ایمیلی با این مشخصات یافت نشد.');
            } else {
                showNotification(`نام کاربری شما "${data}" است.`, 'success');
            }
        });
    </script>
</body>

</html>